<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><style>:root{--accent-color:#FF4D4D}</style><title>Prometheus标签处理&服务发现</title>
<meta name=description content="标签处理的重要性 之前的[配置](https://blog.51ai.vip/2019/10/09/prometueus-yml%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E8%AF%B4%E6%98%8E/中提到了标签的处理,不过由于写的是静态的配置,标签可以自己设置或者不设置都可以.
 …"><meta name=keywords content='blog,aLong,blog.51ai.vip,Prometheus'><meta property="og:url" content="https://blog.51ai.vip/aLong/posts/prometheus%E6%A0%87%E7%AD%BE%E5%A4%84%E7%90%86-%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0/"><meta property="og:type" content="website"><meta property="og:title" content="Prometheus标签处理&服务发现"><meta property="og:description" content="标签处理的重要性 之前的[配置](https://blog.51ai.vip/2019/10/09/prometueus-yml%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E8%AF%B4%E6%98%8E/中提到了标签的处理,不过由于写的是静态的配置,标签可以自己设置或者不设置都可以.
 …"><meta property="og:image" content="https://blog.51ai.vip/aLong/"><meta property="og:image:secure_url" content="https://blog.51ai.vip/aLong/"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="Prometheus标签处理&服务发现"><meta name=twitter:description content="标签处理的重要性 之前的[配置](https://blog.51ai.vip/2019/10/09/prometueus-yml%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E8%AF%B4%E6%98%8E/中提到了标签的处理,不过由于写的是静态的配置,标签可以自己设置或者不设置都可以.
 …"><meta property="twitter:domain" content="https://blog.51ai.vip/aLong/posts/prometheus%E6%A0%87%E7%AD%BE%E5%A4%84%E7%90%86-%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0/"><meta property="twitter:url" content="https://blog.51ai.vip/aLong/posts/prometheus%E6%A0%87%E7%AD%BE%E5%A4%84%E7%90%86-%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0/"><meta name=twitter:image content="https://blog.51ai.vip/aLong/"><link rel=canonical href=https://blog.51ai.vip/aLong/posts/prometheus%E6%A0%87%E7%AD%BE%E5%A4%84%E7%90%86-%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0/><link rel=stylesheet type=text/css href=/aLong/css/normalize.min.css media=print><link rel=stylesheet type=text/css href=/aLong/css/main.min.css><link id=dark-theme rel=stylesheet href=/aLong/css/dark.min.css><script src=/aLong/js/bundle.min.9a920d7dabdbad8363b6a0a94e29a9dfebdb7ee64cfcb193a0145e512ef2bdab.js integrity="sha256-mpINfavbrYNjtqCpTimp3+vbfuZM/LGToBReUS7yvas="></script></head><body><script>setThemeByUserPref()</script><header class=header><nav class=header-nav><div class=nav-title><a class=nav-brand href=https://blog.51ai.vip/aLong/>aLong Blog</a></div><div class=nav-links><div class=nav-link><a href=https://blog.51ai.vip/aLong/><span data-feather=home></span> Home</a></div><div class=nav-link><a href=https://blog.51ai.vip/aLong/posts/>Posts</a></div><div class=nav-link><a href=https://blog.51ai.vip/aLong/tags/>Tags</a></div><div class=nav-link><a href=https://blog.51ai.vip/aLong/index.xml><span data-feather=rss></span></a></div><span class=nav-icons-divider></span><div class="nav-link dark-theme-toggle"><span class="sr-only dark-theme-toggle-screen-reader-target"></span>
<a><span class=theme-toggle-icon data-feather=moon></span></a></div><div class=nav-link id=hamburger-menu-toggle><span class="sr-only hamburger-menu-toggle-screen-reader-target">menu</span>
<a><span data-feather=menu></span></a></div><ul class="nav-hamburger-list visibility-hidden"><li class=nav-item><a href=https://blog.51ai.vip/aLong/><span data-feather=home></span> Home</a></li><li class=nav-item><a href=https://blog.51ai.vip/aLong/posts/>Posts</a></li><li class=nav-item><a href=https://blog.51ai.vip/aLong/tags/>Tags</a></li><li class=nav-item><a href=https://blog.51ai.vip/aLong/index.xml><span data-feather=rss></span></a></li><li class="nav-item dark-theme-toggle"><span class="sr-only dark-theme-toggle-screen-reader-target">theme</span>
<a><span class=theme-toggle-icon data-feather=moon></span></a></li></ul></div></nav></header><main id=content><div class="post container"><div class=post-header-section><h1>Prometheus标签处理&服务发现</h1><small role=doc-subtitle></small><p class=post-date>2019/12/03</p><ul class=post-tags><li class=post-tag><a href=https://blog.51ai.vip/aLong/tags/prometheus>Prometheus</a></li></ul></div><div class=post-content><h3 id=标签处理的重要性>标签处理的重要性</h3><p>之前的[配置](<a href=https://blog.51ai.vip/2019/10/09/prometueus-yml%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E8%AF%B4%E6%98%8E/>https://blog.51ai.vip/2019/10/09/prometueus-yml%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E8%AF%B4%E6%98%8E/</a>中提到了标签的处理,不过由于写的是静态的配置,标签可以自己设置或者不设置都可以.</p><p>当使用服务发现之后发现标签处理的重要性提升了更高的级别.</p><h3 id=标签处理>标签处理</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span> - <span style=color:#f92672>job_name</span>: <span style=color:#e6db74>&#39;node&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>static_configs</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>targets</span>: [<span style=color:#e6db74>&#39;172.16.23.110:9100&#39;</span>,<span style=color:#e6db74>&#39;172.16.23.111:9100&#39;</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>metric_relable_configs</span>:  <span style=color:#75715e>#通过正则重命名标签</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>action</span>: <span style=color:#ae81ff>replace </span> <span style=color:#75715e>#replace替换是默认动作。keep（只参加匹配标签的实例）、drop（不采集匹配正则的实例）、labelkeep\labeldrop(对标签进行过滤处理而非实例)等动作</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>source_labels</span>: [<span style=color:#e6db74>&#39;job&#39;</span>]  <span style=color:#75715e>#原标签，job是默认就会产生的标签，这里job标签的值是node</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>regex</span>: <span style=color:#ae81ff>(.*) </span> <span style=color:#75715e>#正则匹配，这里匹配job标签内的内容，也就是node</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>replacement</span>: <span style=color:#ae81ff>beijing </span> <span style=color:#75715e>#替换成什么内容，如果写$1就是将正则里读取的值</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>target_label</span>: <span style=color:#ae81ff>idc </span> <span style=color:#75715e>#把替换内容赋值给idc标签</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>action</span>: <span style=color:#ae81ff>labeldrop </span> <span style=color:#75715e>#删除标签</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>regex</span>: <span style=color:#ae81ff>job </span> <span style=color:#75715e>#把原job标签删除</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>job_name</span>: <span style=color:#e6db74>&#39;prometheus&#39;</span>
</span></span><span style=display:flex><span>   <span style=color:#f92672>static_configs</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>targets</span>: [<span style=color:#e6db74>&#39;localhost:9090&#39;</span>]
</span></span><span style=display:flex><span>      <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>location</span>: <span style=color:#ae81ff>bj3</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>relabel_configs</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>action</span>: <span style=color:#ae81ff>replace</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>source_labels</span>: [<span style=color:#e6db74>&#39;job&#39;</span>]
</span></span><span style=display:flex><span>      <span style=color:#f92672>regex</span>: <span style=color:#ae81ff>(.*)</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>replacement</span>: <span style=color:#ae81ff>$1</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>target_label</span>: <span style=color:#ae81ff>server</span>
</span></span></code></pre></div><p>以上两个例子都是替换标签,job:node中,删除了前job标签,下面的job新增了&rsquo;server&rsquo;标签内容取的job内容,但没删除job标签.</p><p>通过标签我们组成多维模型.可以对标签重命名,删除,过滤信息等.</p><h3 id=服务发现>服务发现</h3><p>之前配置中的静态配置需要一个一些写配置,设备或者服务多的时候容易头大.</p><p>这里可以通过服务发现简化手动配置工作.</p><p>Prometheus支持多种服务发现机制,例如: consul、dns、openstack、file、kubernetes等.</p><p>这里举例file.比较简单的方式.</p><p>file机制中:需要提供文件来获取内容.文件格式为YAML 或 JSON格式.</p><p>prometheus配置:</p><pre tabindex=0><code>scrape_configs:
  - job_name: &#39;prometheus&#39;
    file_sd_configs: 
      - files: [&#39;/usr/local/prometheus/files_sd_configs/*.yaml&#39;]  
        ##指定服务发现文件位置
        refresh_interval: 5s
        ##刷新间隔改为5秒
</code></pre><p>Prometheus 每5秒扫描一次指定位置的配置文件.</p><p>服务发现文件格式:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>targets</span>: [<span style=color:#e6db74>&#39;localhost:9090&#39;</span>]    <span style=color:#75715e># 监控目标</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>labels</span>:                        <span style=color:#75715e># 配置标签</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>server</span>: <span style=color:#ae81ff>local           </span>
</span></span></code></pre></div></div><div class=prev-next></div><svg id="btt-button" class="arrow-logo" height="1em" viewBox="0 0 384 512" onclick="scrollToTop()" title="Go to top"><path d="M177 159.7l136 136c9.4 9.4 9.4 24.6.0 33.9l-22.6 22.6c-9.4 9.4-24.6 9.4-33.9.0L160 255.9l-96.4 96.4c-9.4 9.4-24.6 9.4-33.9.0L7 329.7c-9.4-9.4-9.4-24.6.0-33.9l136-136c9.4-9.5 24.6-9.5 34-.1z"/></svg>
<script>let backToTopButton=document.getElementById("btt-button");window.onscroll=function(){scrollFunction()};function scrollFunction(){document.body.scrollTop>20||document.documentElement.scrollTop>20?backToTopButton.style.display="block":backToTopButton.style.display="none"}function scrollToTop(){window.scrollTo(0,0)}</script></div></main><footer class=footer><span>&copy; 2019 aLong</span>
<span>Made with &#10084;&#65039; using <a target=_blank href=https://github.com/526avijitgupta/gokarna>Gokarna</a></span></footer></body></html>