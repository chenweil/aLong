<!DOCTYPE html>
<html lang="en" dir=" auto">

<head><script src="/aLong/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=aLong/livereload" data-no-instant defer></script>
</head>

<body class="" id="
    top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/aLong/" accesskey="h" title="aLong blog (Alt + H)">aLong blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title entry-hint-parent">
      Prometheus-snmp_export部署
    </h1>
    <div class="post-meta"><span title='2019-08-29 10:06:01 +0000 UTC'>2019-08-29</span>

</div>
  </header> 
  <div class="post-content"><h2 id="snmp">SNMP<a hidden class="anchor" aria-hidden="true" href="#snmp">#</a></h2>
<p>SNMP(simple network management protocol)是因特网架构委员会IAB定义的一个应用层协议。SNMP广泛用于管理和监控网络设备，大多数专业的网络设备都有SNMP agent代理，这些代理被激活和配置后用于和SNMP管理 NMS(network management system)网络管理系统通信。</p>
<h2 id="目的">目的<a hidden class="anchor" aria-hidden="true" href="#目的">#</a></h2>
<p>通过snmp_export,获取设备信息.</p>
<h2 id="准备">准备<a hidden class="anchor" aria-hidden="true" href="#准备">#</a></h2>
<p>系统: centos7,docker19.
之前已经安装好 Prometheus</p>
<p>此处目标设备是华为交换机 s2700</p>
<h2 id="部署snmp_expoer">部署snmp_expoer<a hidden class="anchor" aria-hidden="true" href="#部署snmp_expoer">#</a></h2>
<p>snmp.yml 配置文件不是自己定义的,是通过注册生成或下载的.这里我通过github下载配置文件.</p>
<p><a href="https://github.com/prometheus/snmp_exporter/blob/master/snmp.yml">snmp.yml</a></p>
<ul>
<li>配置snmp_export 配置文件 snmp.yml</li>
</ul>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">version</span>:<span style="color:#bbb"> </span><span style="color:#666">2</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">auth</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">community</span>:<span style="color:#bbb"> </span><span style="color:#bc7a00">**交换机设置的团体名**</span><span style="color:#bbb">
</span></span></span></code></pre></div><p>查找到if_mib 再此段结尾中加入 上面的配置(大概行数6199).</p>
<p><img loading="lazy" src="https://t1.picb.cc/uploads/2019/08/29/gjuSAc.png" alt="demo"  />
</p>
<h3 id="部署snmp_expor">部署snmp_expor<a hidden class="anchor" aria-hidden="true" href="#部署snmp_expor">#</a></h3>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>docker run -d --restart always <span style="color:#b62;font-weight:bold">\
</span></span></span><span style="display:flex;"><span><span style="color:#b62;font-weight:bold"></span>-v /home/along/snmp.yml:/etc/snmp_exporter/snmp.yml <span style="color:#b62;font-weight:bold">\
</span></span></span><span style="display:flex;"><span><span style="color:#b62;font-weight:bold"></span>-p 9116:9116 --name snmp-exporter prom/snmp-exporter <span style="color:#b62;font-weight:bold">\ </span>--config.file<span style="color:#666">=</span><span style="color:#ba2121">&#34;/etc/snmp_exporter/snmp.yml&#34;</span>
</span></span></code></pre></div><h3 id="配置华为s2700交换机">配置华为s2700交换机<a hidden class="anchor" aria-hidden="true" href="#配置华为s2700交换机">#</a></h3>
<p>自行查阅文档.懒得写了.</p>
<h3 id="验证服务">验证服务<a hidden class="anchor" aria-hidden="true" href="#验证服务">#</a></h3>
<p>访问 http://IP:9116/metrics 能返回数据,snmp_export服务正常.</p>
<p>测试是否能获取到目标设备的数据:
访问 http://IP:9116/snmp?target=DEVIP
能获取到数据,配置成功.</p>
<p><strong>注意防火墙 把需要的端口加入规则中,不然访问不到排查绕弯路</strong></p>
<h3 id="配置promthues">配置promthues<a hidden class="anchor" aria-hidden="true" href="#配置promthues">#</a></h3>
<p>修改 promthues.yml文件. 添加一个新的job.</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span>- <span style="color:#008000;font-weight:bold">job_name</span>:<span style="color:#bbb"> </span>snmp<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">honor_timestamps</span>:<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">true</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">params</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">module</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>- if_mib<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">scrape_interval</span>:<span style="color:#bbb"> </span>15s<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">scrape_timeout</span>:<span style="color:#bbb"> </span>10s<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">metrics_path</span>:<span style="color:#bbb"> </span>/snmp<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">scheme</span>:<span style="color:#bbb"> </span>http<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">static_configs</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>- <span style="color:#008000;font-weight:bold">targets</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>- <span style="color:#666">172.16.23.253</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">labels</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#008000;font-weight:bold">tag</span>:<span style="color:#bbb"> </span>huawei-switch-s2700<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">relabel_configs</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>- <span style="color:#008000;font-weight:bold">source_labels</span>:<span style="color:#bbb"> </span>[__address__]<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">separator</span>:<span style="color:#bbb"> </span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">regex</span>:<span style="color:#bbb"> </span>(.*)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">target_label</span>:<span style="color:#bbb"> </span>__param_target<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">replacement</span>:<span style="color:#bbb"> </span>$1<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">action</span>:<span style="color:#bbb"> </span>replace<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>- <span style="color:#008000;font-weight:bold">source_labels</span>:<span style="color:#bbb"> </span>[__param_target]<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">separator</span>:<span style="color:#bbb"> </span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">regex</span>:<span style="color:#bbb"> </span>(.*)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">target_label</span>:<span style="color:#bbb"> </span>instance<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">replacement</span>:<span style="color:#bbb"> </span>$1<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">action</span>:<span style="color:#bbb"> </span>replace<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>- <span style="color:#008000;font-weight:bold">separator</span>:<span style="color:#bbb"> </span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">regex</span>:<span style="color:#bbb"> </span>(.*)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">target_label</span>:<span style="color:#bbb"> </span>__address__<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">replacement</span>:<span style="color:#bbb"> </span><span style="color:#666">172.16.23.12</span>:<span style="color:#666">9116</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">action</span>:<span style="color:#bbb"> </span>replace<span style="color:#bbb">
</span></span></span></code></pre></div><p>之前部署prometheus 有一个参数是为了热加载配置的.
这里需要reload一下配置,<code>curl -X POST http://IP:9090/-/reload</code>,如果你没有就重启服务吧.</p>
<h3 id="验证-prometheus配置">验证 Prometheus配置<a hidden class="anchor" aria-hidden="true" href="#验证-prometheus配置">#</a></h3>
<p>访问 http://IP:9090/
点击 Status-&gt;Target 可以看到监控的节点,之前我们是有一个,现在是两个节点了.</p>
<p><img loading="lazy" src="https://t1.picb.cc/uploads/2019/08/29/gjCvPF.png" alt=""  />
</p>
<p>有数据之后,就可以在grafana中展示设备的数据了.</p>
<h2 id="参考">参考<a hidden class="anchor" aria-hidden="true" href="#参考">#</a></h2>
<p><a href="https://github.com/prometheus/snmp_exporter">https://github.com/prometheus/snmp_exporter</a></p>
<p><a href="https://prometheus.io/docs/instrumenting/exporters/">https://prometheus.io/docs/instrumenting/exporters/</a></p>
<p><a href="http://owelinux.github.io/owelinux.github.io/2018/07/25/article8-linux-prometheus/">http://owelinux.github.io/owelinux.github.io/2018/07/25/article8-linux-prometheus/</a></p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="http://localhost:1313/aLong/tags/snmp/">SNMP</a></li>
      <li><a href="http://localhost:1313/aLong/tags/promethues/">Promethues</a></li>
    </ul>
  </footer>
</article>
    </main>
    <footer>
    // ... 其他页脚内容 ...
    <a href="http://localhost:1313/aLong/index.xml">订阅RSS</a>
</footer></body>

</html>