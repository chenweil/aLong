<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Prometheus on aLong Blog</title><link>https://blog.51ai.vip/tags/prometheus/</link><description>Recent content in Prometheus on aLong Blog</description><generator>Hugo</generator><language>en</language><lastBuildDate>Fri, 23 Jun 2023 00:00:00 +0000</lastBuildDate><atom:link href="https://blog.51ai.vip/tags/prometheus/index.xml" rel="self" type="application/rss+xml"/><item><title>Nightingle夜莺Docker版SNMP监控</title><link>https://blog.51ai.vip/posts/nightingle%E5%A4%9C%E8%8E%BAdocker%E7%89%88snmp%E7%9B%91%E6%8E%A7/</link><pubDate>Fri, 23 Jun 2023 00:00:00 +0000</pubDate><guid>https://blog.51ai.vip/posts/nightingle%E5%A4%9C%E8%8E%BAdocker%E7%89%88snmp%E7%9B%91%E6%8E%A7/</guid><description>&lt;h2 id="起因">起因&lt;/h2>
&lt;p>对夜莺很感兴趣，想使用一下。我看官方提供了v6版本的docker-compose。而且我之前有使用过promtheus和grafana，虽然很好但是总觉得还是得二开。总有一天有人去搞一个不错的玩意儿出来。&lt;a href="https://flashcat.cloud/docs/">官方文档地址&lt;/a>&lt;/p>
&lt;h2 id="安装与配置">安装与配置&lt;/h2>
&lt;p>直接运行docker版本的demo，启动后，我发现有prometheus和categraf。但我想根据官方文档使用VictoriaMetrics单机版本。&lt;/p>
&lt;h3 id="使用victoriametrics">使用VictoriaMetrics&lt;/h3>
&lt;p>我在compose中去掉了prometheus，然后在主机安装了VictoriaMetrics。我没用在compose中添加，我懒改了。直接看官当文档多香。&lt;/p>
&lt;p>后面启动后修改数据源：
&lt;img src="https://img-blog.csdnimg.cn/img_convert/13af579a7f90bfb9a5d197de818b08ab.png" alt="ZviA7j7">&lt;/p>
&lt;p>添加好数据源后，看下是否正常：
时序指标随便敲敲看有没指标
&lt;img src="https://img-blog.csdnimg.cn/img_convert/3cb79c47b991fef817056f3dc5bab48c.png" alt="WxPg5Rs">
看到有指标我很自信的说成了。&lt;/p>
&lt;p>后面我加了两个Ping，发现可以没问题的。&lt;/p>
&lt;p>&lt;img src="https://img-blog.csdnimg.cn/img_convert/60fd758e67e9dc0fd712bae376735e00.png" alt="JoY5v64">
使用内置的展示仪表盘美滋滋。&lt;/p>
&lt;h3 id="snmp部分">SNMP部分&lt;/h3>
&lt;p>之后我想测试SNMP部分，这是我工作需要的内容。&lt;/p>
&lt;p>首先默认的官方demo没有提供相关categraf插件配置。他的插件都是在github上面的。下载一份放到demo的categraf/conf目录下。
我的路径： &lt;code>home/xxx/nightingate/docker/categraf/conf&lt;/code>&lt;/p>
&lt;p>我这里用到snmp， 就拷贝input.snmp 这个目录到上面路径内。&lt;/p>
&lt;p>进入这个&lt;code>input.snmp&lt;/code>,里面有两个文件,一个 &lt;code>snmp.toml&lt;/code>另一个是&lt;code>snmp.toml.example&lt;/code> 。实际使用的是第一个，在里面编辑内容：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-toml" data-lang="toml">&lt;span style="display:flex;">&lt;span>[[&lt;span style="color:#a6e22e">instances&lt;/span>]]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">agents&lt;/span> = [&lt;span style="color:#e6db74">&amp;#34;udp://10.10.10.2:161&amp;#34;&lt;/span>]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">timeout&lt;/span> = &lt;span style="color:#e6db74">&amp;#34;5s&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">version&lt;/span> = &lt;span style="color:#ae81ff">2&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">path&lt;/span> = [&lt;span style="color:#e6db74">&amp;#34;/usr/share/snmp/mibs&amp;#34;&lt;/span>]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">community&lt;/span> = &lt;span style="color:#e6db74">&amp;#34;public&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">agent_host_tag&lt;/span> = &lt;span style="color:#e6db74">&amp;#34;switch&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">retries&lt;/span> = &lt;span style="color:#ae81ff">1&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>[[&lt;span style="color:#a6e22e">instances&lt;/span>.&lt;span style="color:#a6e22e">field&lt;/span>]]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">oid&lt;/span> = &lt;span style="color:#e6db74">&amp;#34;.1.3.6.1.2.1.1.3.0&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">name&lt;/span> = &lt;span style="color:#e6db74">&amp;#34;uptime&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>[[&lt;span style="color:#a6e22e">instances&lt;/span>.&lt;span style="color:#a6e22e">field&lt;/span>]]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">oid&lt;/span> = &lt;span style="color:#e6db74">&amp;#34;.1.3.6.1.2.1.1.5.0&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">name&lt;/span> = &lt;span style="color:#e6db74">&amp;#34;source&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">is_tag&lt;/span> = &lt;span style="color:#66d9ef">true&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>[[&lt;span style="color:#a6e22e">instances&lt;/span>.&lt;span style="color:#a6e22e">table&lt;/span>]]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">oid&lt;/span> = &lt;span style="color:#e6db74">&amp;#34;IF-MIB::ifTable&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">name&lt;/span> = &lt;span style="color:#e6db74">&amp;#34;interface&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">inherit_tags&lt;/span> = [&lt;span style="color:#e6db74">&amp;#34;source&amp;#34;&lt;/span>]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">index_as_tag&lt;/span> = &lt;span style="color:#66d9ef">true&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">include_filter&lt;/span> = [&lt;span style="color:#e6db74">&amp;#34;ifIndex:2&amp;#34;&lt;/span>,&lt;span style="color:#e6db74">&amp;#34;ifIndex:4&amp;#34;&lt;/span>]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>[[&lt;span style="color:#a6e22e">instances&lt;/span>.&lt;span style="color:#a6e22e">table&lt;/span>.&lt;span style="color:#a6e22e">field&lt;/span>]]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">oid&lt;/span> = &lt;span style="color:#e6db74">&amp;#34;IF-MIB::ifDescr&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">name&lt;/span> = &lt;span style="color:#e6db74">&amp;#34;ifDescr&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">is_tag&lt;/span> = &lt;span style="color:#66d9ef">true&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>[[&lt;span style="color:#a6e22e">instances&lt;/span>.&lt;span style="color:#a6e22e">table&lt;/span>.&lt;span style="color:#a6e22e">field&lt;/span>]]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">oid&lt;/span> = &lt;span style="color:#e6db74">&amp;#34;IF-MIB::ifPhysAddress&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">name&lt;/span> = &lt;span style="color:#e6db74">&amp;#34;ifPhysAddress&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">is_tag&lt;/span> = &lt;span style="color:#66d9ef">true&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="遇到问题">遇到问题&lt;/h3>
&lt;p>保存重启categraf后，我只看到了一个指标&lt;code>snmp_uptime&lt;/code>。我单独取&lt;code>uptime&lt;/code>这个是有的，就好像没办法执行&lt;code>snmpwalk&lt;/code> 只能搞&lt;code>snmpget&lt;/code>。&lt;/p></description></item><item><title>docker-compose编排搭建prometheus+grafana+alertmanager+node-exporter+snmp-exporter</title><link>https://blog.51ai.vip/posts/docker-compose%E7%BC%96%E6%8E%92%E6%90%AD%E5%BB%BAprometheus-grafana-alertmanager-node-exporter-snmp-exporter/</link><pubDate>Tue, 17 Nov 2020 13:02:50 +0000</pubDate><guid>https://blog.51ai.vip/posts/docker-compose%E7%BC%96%E6%8E%92%E6%90%AD%E5%BB%BAprometheus-grafana-alertmanager-node-exporter-snmp-exporter/</guid><description>&lt;h2 id="docker-compose">Docker-compose&lt;/h2>
&lt;p>目前集成很多Exporter，加上grafana的image-renderer，后面又加上ping-exporter，很多东西加起来发现操作一次docker 很烦啊。&lt;/p>
&lt;p>科普之后感觉自己对k8s还有有些发怵的。从简单的一个入手吧，选择了docker-compose。&lt;/p>
&lt;blockquote>
&lt;blockquote>
&lt;blockquote>
&lt;p>Docker-Compose项目是Docker官方的开源项目，负责实现对Docker容器集群的快速编排。&lt;/p>&lt;/blockquote>&lt;/blockquote>&lt;/blockquote>
&lt;h3 id="安装">安装&lt;/h3>
&lt;p>安装方式看了一下，我选择直接下载bin文件方式：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>curl -L https://get.daocloud.io/docker/compose/releases/download/1.12.0/docker-compose-&lt;span style="color:#e6db74">`&lt;/span>uname -s&lt;span style="color:#e6db74">`&lt;/span>-&lt;span style="color:#e6db74">`&lt;/span>uname -m&lt;span style="color:#e6db74">`&lt;/span> &amp;gt; /usr/local/bin/docker-compose
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>chmod +x /usr/local/bin/docker-compose&lt;span style="color:#e6db74">```&lt;/span> 
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>通过 &lt;code>docker-compose version&lt;/code> 看到版本信息算是安装完成。&lt;/p>
&lt;h3 id="编写docker-composeyml">编写docker-compose.yml&lt;/h3>
&lt;ol>
&lt;li>目录结构：&lt;/li>
&lt;/ol>
&lt;pre tabindex="0">&lt;code>├── docker-compose.yaml
├── prometheus
│ ├── rules 
│ │ └── *(rules).yaml/json
│ ├── nodes
│ │ └── *(nodes).yaml
│ ├── data
│ │ └── ... # 挂载prom的data数据
│ └── prometheus.yaml
├── alertmanager
│ ├── templates
│ │ └── *.tmpl
│ └── alertmanager.yaml
├── grafana
│ ├── data
│ │ ├── plugins #插件目录
│ │ ├── png 
│ │ └── grafana.db
│ └── grafana.ini
├── snmp(snmp_exporter)
│ └── snmp.yml
└── blackbox(balck box-exporter)
 └── blackbox.yml
&lt;/code>&lt;/pre>&lt;ol start="2">
&lt;li>
&lt;p>根据结构编写&lt;/p></description></item><item><title>Prometheus-SNMP_Exporter Generator</title><link>https://blog.51ai.vip/posts/prometheus-snmp-exporter-generator/</link><pubDate>Tue, 24 Dec 2019 15:26:33 +0000</pubDate><guid>https://blog.51ai.vip/posts/prometheus-snmp-exporter-generator/</guid><description>&lt;h2 id="prometheus-snmp-exporter">Prometheus-SNMP Exporter&lt;/h2>
&lt;blockquote>
&lt;p>生成器从generator.yml读取并写入snmp.yml。&lt;/p>&lt;/blockquote>
&lt;p>之前在说&lt;a href="https://blog.51ai.vip/2019/08/29/Prometheus-snmp-export%E9%83%A8%E7%BD%B2/">Prometheus-snmp_export部署&lt;/a>时,没有具体提到snmp.yml的生成器是怎么生成的.几乎用的都是github上的&lt;a href="https://github.com/prometheus/snmp_exporter/blob/master/snmp.yml">snmp.yml&lt;/a>文件(只在demo中添加了auth配置).&lt;/p>
&lt;p>因为刚好所有通用的指标都取得通用的mib树. 在后期我搜集设备的信息需要一些私有mib的数据,这时候需要自己通过生成器来生成snmp.yml.&lt;/p>
&lt;h2 id="generator-的操作步骤">Generator 的操作步骤&lt;/h2>
&lt;h3 id="下载需要的程序docker方式跳过此步骤">下载需要的程序(Docker方式跳过此步骤)&lt;/h3>
&lt;pre tabindex="0">&lt;code># Debian-based distributions.
sudo apt-get install unzip build-essential libsnmp-dev # Debian-based distros
# Redhat-based distributions.
sudo yum install gcc gcc-g++ make net-snmp net-snmp-utils net-snmp-libs net-snmp-devel # RHEL-based distros

go get github.com/prometheus/snmp_exporter/generator
cd ${GOPATH-$HOME/go}/src/github.com/prometheus/snmp_exporter/generator
go build
make mibs(不建议直接make)
&lt;/code>&lt;/pre>&lt;p>这里直接make mibs 可能会失败,在make文件里设置的源有些已经不能访问了或执行出现错误.&lt;/p>
&lt;p>我建议先下载好mibs ,我已经上传&lt;a href="https://github.com/chenweil/mibs">github&lt;/a>.&lt;/p>
&lt;p>&lt;em>&lt;strong>建议自行搜集mib 不执行make mibs会方便一些&lt;/strong>&lt;/em>&lt;/p>
&lt;p>把所有的mib放入mibs 目录下.&lt;/p>
&lt;p>需要准备好所有需要涉及到的mib文件. 除了公有的mib,我们还需要监控目标设备的私有mib.思科/华为之类的会提供这些mib,像锐捷这种需要和商务部联系.&lt;/p>
&lt;hr>
&lt;p>&lt;em>一些mib:&lt;/em>&lt;/p>
&lt;p>&lt;a href="https://github.com/netdisco/netdisco-mibs">https://github.com/netdisco/netdisco-mibs&lt;/a>&lt;/p>
&lt;p>&lt;a href="https://github.com/pgmillon/observium/tree/master/mibs">https://github.com/pgmillon/observium/tree/master/mibs&lt;/a>&lt;/p>
&lt;p>&lt;a href="https://github.com/librenms/librenms/tree/master/mibs">https://github.com/librenms/librenms/tree/master/mibs&lt;/a>&lt;/p>
&lt;hr>
&lt;h3 id="当我们准备好所有的mib后需要编写一个generatoryml">当我们准备好所有的mib后,需要编写一个generator.yml.&lt;/h3>
&lt;p>&lt;code>下面是一个翻译的官方文档(翻译比较烂,自行查阅[原文]([https://github.com/prometheus/snmp\_exporter/tree/master/generator](https://github.com/prometheus/snmp\_exporter/tree/master/generator))):&lt;/code>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-yaml" data-lang="yaml">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">modules&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">module_name&lt;/span>: &lt;span style="color:#75715e"># 模块名称。您可以根据需要拥有任意数量的模块。&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">walk&lt;/span>: &lt;span style="color:#75715e"># 要walk的OID列表。 也可以是SNMP对象名称或特定实例。&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#ae81ff">1.3.6.1.2.1.2&lt;/span> &lt;span style="color:#75715e"># 与“接口”相同。&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#ae81ff">sysUpTime &lt;/span> &lt;span style="color:#75715e"># 与“ 1.3.6.1.2.1.1.3”相同。&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#ae81ff">1.3.6.1.2.1.31.1.1.1.6.40&lt;/span> &lt;span style="color:#75715e"># 索引为“ 40”的“ ifHCInOctets”的实例。&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">version&lt;/span>: &lt;span style="color:#ae81ff">2&lt;/span> &lt;span style="color:#75715e"># 要使用的SNMP版本。 默认2。&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># 1将使用GETNEXT，2和3将使用GETBULK。&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">max_repetitions&lt;/span>: &lt;span style="color:#ae81ff">25&lt;/span> &lt;span style="color:#75715e"># 使用GET / GETBULK请求多少个对象，默认为25。&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># 对于有故障的设备，可能需要减少。&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">retries&lt;/span>: &lt;span style="color:#ae81ff">3&lt;/span> &lt;span style="color:#75715e"># 重试失败请求的次数，默认为3。&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">timeout&lt;/span>: &lt;span style="color:#ae81ff">10s&lt;/span> &lt;span style="color:#75715e"># 每次步行的超时时间，默认为10秒。&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">auth&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># 社区字符串与SNMP v1和v2一起使用。 默认为“ public”。&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">community&lt;/span>: &lt;span style="color:#ae81ff">public&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># v3具有不同且更复杂的设置。&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># 需要哪些取决于security_level。&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># 还列出了NetSNMP命令上的等效选项，例如snmpbulkwalk和snmpget。&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># 请参见snmpcmd（1）。&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">username&lt;/span>: &lt;span style="color:#ae81ff">user &lt;/span> &lt;span style="color:#75715e"># 必需，无默认值。 NetSNMP的-u选项。&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">security_level&lt;/span>: &lt;span style="color:#ae81ff">noAuthNoPriv &lt;/span> &lt;span style="color:#75715e"># 默认为noAuthNoPriv。 NetSNMP的-l选项。&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># 可以是noAuthNoPriv，authNoPriv或authPriv。&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">password&lt;/span>: &lt;span style="color:#ae81ff">pass &lt;/span> &lt;span style="color:#75715e"># 没有默认值。 也称为authKey，NetSNMP的-A选项。&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># 如果security_level是authNoPriv或authPriv，则为必需。&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">auth_protocol&lt;/span>: &lt;span style="color:#ae81ff">MD5 &lt;/span> &lt;span style="color:#75715e"># MD5或SHA，默认为MD5。 -NetSNMP的选项。&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># 如果security_level为authNoPriv或authPriv，则使用此属性。&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">priv_protocol&lt;/span>: &lt;span style="color:#ae81ff">DES &lt;/span> &lt;span style="color:#75715e"># DES或AES，默认为DES。 NetSNMP的-x选项。&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># 如果security_level为authPriv，则使用。&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">priv_password&lt;/span>: &lt;span style="color:#ae81ff">otherPass&lt;/span> &lt;span style="color:#75715e"># 没有默认值。 也称为privKey，NetSNMP的-X选项。&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># 如果security_level是authPriv，则为必需。&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">context_name&lt;/span>: &lt;span style="color:#ae81ff">context&lt;/span> &lt;span style="color:#75715e"># 没有默认值。 NetSNMP的-n选项。&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># 如果在设备上配置了上下文，则为必需。&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">lookups&lt;/span>: &lt;span style="color:#75715e"># 要执行的查找的可选列表。&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># “keep_source_indexes”的默认值为false。 &lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># 索引必须唯一，才能使用此选项。&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># 如果表的索引是bsnDot11EssIndex，则通常是该表结果度量的标签。&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># 相反,使用索引查找bsnDot11EssSsid表条目，并使用该值创建一个bsnDot11EssSsid标签。&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#f92672">source_indexes&lt;/span>: [&lt;span style="color:#ae81ff">bsnDot11EssIndex]&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">lookup&lt;/span>: &lt;span style="color:#ae81ff">bsnDot11EssSsid&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">drop_source_indexes&lt;/span>: &lt;span style="color:#66d9ef">false&lt;/span> &lt;span style="color:#75715e"># 如果为true，则删除此查找的源索引标签。&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># 当新索引唯一时，这可以避免标签混乱。&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">overrides&lt;/span>: &lt;span style="color:#75715e"># 允许每个模块覆盖MIB的位&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">metricName&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">ignore&lt;/span>: &lt;span style="color:#66d9ef">true&lt;/span> &lt;span style="color:#75715e"># 从输出中删除度量。&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">regex_extracts&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">Temp&lt;/span>: &lt;span style="color:#75715e"># 将创建一个新的度量，并将其附加到metricName上，成为metricNameTemp。&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#f92672">regex&lt;/span>: &lt;span style="color:#e6db74">&amp;#39;(.*)&amp;#39;&lt;/span> &lt;span style="color:#75715e"># 正则表达式从返回的SNMP walk的值中提取一个值。&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">value&lt;/span>: &lt;span style="color:#e6db74">&amp;#39;$1&amp;#39;&lt;/span> &lt;span style="color:#75715e"># 结果将解析为float64，默认为$1。&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">Status&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#f92672">regex&lt;/span>: &lt;span style="color:#e6db74">&amp;#39;.*Example&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">value&lt;/span>: &lt;span style="color:#e6db74">&amp;#39;1&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#f92672">regex&lt;/span>: &lt;span style="color:#e6db74">&amp;#39;.*&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">value&lt;/span>: &lt;span style="color:#e6db74">&amp;#39;0&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">type&lt;/span>: &lt;span style="color:#ae81ff">DisplayString&lt;/span> &lt;span style="color:#75715e"># 覆盖度量标准类型，可能的类型有：&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># gauge: 带gauge的整数。&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># counter: 带类型计数器的整数。&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># OctetString: 一个位字符串，呈现为0xff34。&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># DateAndTime: RFC 2579日期和时间字节序列。如果设备没有时区数据，则使用UTC。&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># DisplayString: ASCII或UTF-8字符串。&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># PhysAddress48: 一个48位的MAC地址，呈现为00:01:02:03:04:ff。&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># Float: 一个32位浮点值，带有类型gauge。&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># Double: 一个64位浮点值，带有类型gauge。&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># InetAddressIPv4: IPv4地址，呈现为1.2.3.4。&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># InetAddressIPv6: IPv6地址，呈现为0102:0304:0506:0708:090A:0B0C:0D0E:0F10。&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># InetAddress: 每个RFC 4001有一个InetAddress。必须以InetAddressType开头。&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># InetAddressMissingSize: 因索引中没有大小而违反RFC 4001第4.1节的InetAddress。&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># 必须以InetAddressType开头。&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># EnumAsInfo: 为其创建单个时间序列的枚举。适用于恒定值。&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># EnumAsStateSet: 每个状态具有时间序列的枚举。适用于可变低基数枚举。&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># Bits: 一种RFC2578位结构，它产生一个具有每位时间序列的状态集。&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>下面提供一个自己编写的generator.yml&lt;/p></description></item><item><title>Prometheus告警模板详解</title><link>https://blog.51ai.vip/posts/prometheus%E5%91%8A%E8%AD%A6%E6%A8%A1%E6%9D%BF%E8%AF%A6%E8%A7%A3/</link><pubDate>Wed, 04 Dec 2019 11:51:43 +0000</pubDate><guid>https://blog.51ai.vip/posts/prometheus%E5%91%8A%E8%AD%A6%E6%A8%A1%E6%9D%BF%E8%AF%A6%E8%A7%A3/</guid><description>&lt;h2 id="目的">目的&lt;/h2>
&lt;p>之前配置告警之后,可以发送告警信息.但对于数据具体的结构信息,在模板中数据读取都比较懵.原因是不太清除警报都提供了哪些数据,除了我们设置的信息,还有没有其他的信息.&lt;/p>
&lt;h3 id="告警数据结构">告警数据结构&lt;/h3>
&lt;p>&lt;a href="https://prometheus.io/docs/alerting/notifications/#alert">官方docs&lt;/a>&lt;/p>
&lt;p>推送数据结构:&lt;/p>
&lt;!-- raw HTML omitted -->
&lt;h3 id="alerts数据">Alerts数据&lt;/h3>
&lt;!-- raw HTML omitted -->
&lt;h3 id="kv数据的处理方式">KV数据的处理方式&lt;/h3>
&lt;p>KV结构很简单,键值对.通过键获取对应的值.下面提供了一些方法处理这种结构的一些方法.&lt;/p>
&lt;!-- raw HTML omitted -->
&lt;h3 id="字符串相关方法">字符串相关方法&lt;/h3>
&lt;p>警报提供的数据是通过GO模板解析的,GO模板的功能通过&lt;a href="https://golang.org/pkg/text/template/#hdr-Functions">GO模板文档&lt;/a>可以了解.&lt;/p>
&lt;p>下面提供了一些处理字符串的方法:&lt;/p>
&lt;p>&lt;img src="https://t1.picb.cc/uploads/2019/12/05/kngppe.png" alt="">&lt;/p>
&lt;h3 id="微信通知的demo">微信通知的DEMO&lt;/h3>
&lt;p>&lt;img src="https://t1.picb.cc/uploads/2019/12/05/kngxOt.png" alt="">&lt;/p>
&lt;p>上图中是微信接受的通知,下面展示通知模板的代码.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-tmpl" data-lang="tmpl">&lt;span style="display:flex;">&lt;span>{{- define &amp;#34;_alert_list&amp;#34; -}}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{{- range .Alerts.Firing -}}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>-----------------------
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>告警类型：{{ .Labels.alertname }}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>告警主题: {{ .Annotations.summary }}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>告警详情: {{ .Annotations.description }}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>触发时间: {{ (.StartsAt.Add 28800e9).Format &amp;#34;2006-01-02 15:04:05&amp;#34; }}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{{ end -}}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>---------结束-----------------
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{{- end -}}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{{- define &amp;#34;_resolve_list&amp;#34; -}}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{{- range .Alerts.Resolved -}}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>**************************
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>告警类型：{{ .Labels.alertname }}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>告警主题: {{ .Annotations.summary }}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>告警详情: {{ .Annotations.description }}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>触发时间: {{ (.StartsAt.Add 28800e9).Format &amp;#34;2006-01-02 15:04:05&amp;#34; }}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>恢复时间: {{ (.EndsAt.Add 28800e9).Format &amp;#34;2006-01-02 15:04:05&amp;#34; }}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{{ end -}}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>************结束*****************
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{{- end -}}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{{- define &amp;#34;wechat.message&amp;#34; -}}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{{- if and (gt (len .Alerts.Firing) 0) (gt (len .Alerts.Resolved) 0) -}}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>告警数量:{{.Alerts.Firing | len}}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>告警设备:{{ .GroupLabels.server}}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{{ template &amp;#34;_alert_list&amp;#34; . }}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>====================================
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>告警恢复:{{len .Alerts.Resolved}}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>告警设备:{{ .GroupLabels.server}}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{{ template &amp;#34;_resolve_list&amp;#34; . }}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{{- else -}}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> {{- if gt (len .Alerts.Firing) 0 -}}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>告警数量:{{.Alerts.Firing | len}}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>告警设备:{{ .GroupLabels.server}} 
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{{ template &amp;#34;_alert_list&amp;#34; . }}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> {{- end -}}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> {{- if gt (len .Alerts.Resolved) 0 -}}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>告警恢复:{{len .Alerts.Resolved}}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>告警设备:{{ .GroupLabels.server}}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{{ template &amp;#34;_resolve_list&amp;#34; . }}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> {{- end -}}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{{- end -}}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{{- end -}}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;strong>其中告警设备 server 这个标签是自定义的.如果没有可以删除此行或根据自己标签定义.&lt;/strong>&lt;/p></description></item><item><title>Prometheus标签处理&amp;服务发现</title><link>https://blog.51ai.vip/posts/prometheus%E6%A0%87%E7%AD%BE%E5%A4%84%E7%90%86-%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0/</link><pubDate>Tue, 03 Dec 2019 15:14:16 +0000</pubDate><guid>https://blog.51ai.vip/posts/prometheus%E6%A0%87%E7%AD%BE%E5%A4%84%E7%90%86-%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0/</guid><description>&lt;h3 id="标签处理的重要性">标签处理的重要性&lt;/h3>
&lt;p>之前的[配置](&lt;a href="https://blog.51ai.vip/2019/10/09/prometueus-yml%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E8%AF%B4%E6%98%8E/">https://blog.51ai.vip/2019/10/09/prometueus-yml%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E8%AF%B4%E6%98%8E/&lt;/a>中提到了标签的处理,不过由于写的是静态的配置,标签可以自己设置或者不设置都可以.&lt;/p>
&lt;p>当使用服务发现之后发现标签处理的重要性提升了更高的级别.&lt;/p>
&lt;h3 id="标签处理">标签处理&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-yaml" data-lang="yaml">&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#f92672">job_name&lt;/span>: &lt;span style="color:#e6db74">&amp;#39;node&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">static_configs&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#f92672">targets&lt;/span>: [&lt;span style="color:#e6db74">&amp;#39;172.16.23.110:9100&amp;#39;&lt;/span>,&lt;span style="color:#e6db74">&amp;#39;172.16.23.111:9100&amp;#39;&lt;/span>]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">metric_relable_configs&lt;/span>: &lt;span style="color:#75715e">#通过正则重命名标签&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#f92672">action&lt;/span>: &lt;span style="color:#ae81ff">replace &lt;/span> &lt;span style="color:#75715e">#replace替换是默认动作。keep（只参加匹配标签的实例）、drop（不采集匹配正则的实例）、labelkeep\labeldrop(对标签进行过滤处理而非实例)等动作&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">source_labels&lt;/span>: [&lt;span style="color:#e6db74">&amp;#39;job&amp;#39;&lt;/span>] &lt;span style="color:#75715e">#原标签，job是默认就会产生的标签，这里job标签的值是node&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">regex&lt;/span>: &lt;span style="color:#ae81ff">(.*) &lt;/span> &lt;span style="color:#75715e">#正则匹配，这里匹配job标签内的内容，也就是node&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">replacement&lt;/span>: &lt;span style="color:#ae81ff">beijing &lt;/span> &lt;span style="color:#75715e">#替换成什么内容，如果写$1就是将正则里读取的值&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">target_label&lt;/span>: &lt;span style="color:#ae81ff">idc &lt;/span> &lt;span style="color:#75715e">#把替换内容赋值给idc标签&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#f92672">action&lt;/span>: &lt;span style="color:#ae81ff">labeldrop &lt;/span> &lt;span style="color:#75715e">#删除标签&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">regex&lt;/span>: &lt;span style="color:#ae81ff">job &lt;/span> &lt;span style="color:#75715e">#把原job标签删除&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>- &lt;span style="color:#f92672">job_name&lt;/span>: &lt;span style="color:#e6db74">&amp;#39;prometheus&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">static_configs&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#f92672">targets&lt;/span>: [&lt;span style="color:#e6db74">&amp;#39;localhost:9090&amp;#39;&lt;/span>]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">labels&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">location&lt;/span>: &lt;span style="color:#ae81ff">bj3&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">relabel_configs&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#f92672">action&lt;/span>: &lt;span style="color:#ae81ff">replace&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">source_labels&lt;/span>: [&lt;span style="color:#e6db74">&amp;#39;job&amp;#39;&lt;/span>]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">regex&lt;/span>: &lt;span style="color:#ae81ff">(.*)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">replacement&lt;/span>: &lt;span style="color:#ae81ff">$1&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">target_label&lt;/span>: &lt;span style="color:#ae81ff">server&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>以上两个例子都是替换标签,job:node中,删除了前job标签,下面的job新增了&amp;rsquo;server&amp;rsquo;标签内容取的job内容,但没删除job标签.&lt;/p>
&lt;p>通过标签我们组成多维模型.可以对标签重命名,删除,过滤信息等.&lt;/p>
&lt;h3 id="服务发现">服务发现&lt;/h3>
&lt;p>之前配置中的静态配置需要一个一些写配置,设备或者服务多的时候容易头大.&lt;/p>
&lt;p>这里可以通过服务发现简化手动配置工作.&lt;/p>
&lt;p>Prometheus支持多种服务发现机制,例如: consul、dns、openstack、file、kubernetes等.&lt;/p>
&lt;p>这里举例file.比较简单的方式.&lt;/p>
&lt;p>file机制中:需要提供文件来获取内容.文件格式为YAML 或 JSON格式.&lt;/p>
&lt;p>prometheus配置:&lt;/p>
&lt;pre tabindex="0">&lt;code>scrape_configs:
 - job_name: &amp;#39;prometheus&amp;#39;
 file_sd_configs: 
 - files: [&amp;#39;/usr/local/prometheus/files_sd_configs/*.yaml&amp;#39;] 
 ##指定服务发现文件位置
 refresh_interval: 5s
 ##刷新间隔改为5秒
&lt;/code>&lt;/pre>&lt;p>Prometheus 每5秒扫描一次指定位置的配置文件.&lt;/p>
&lt;p>服务发现文件格式:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-yaml" data-lang="yaml">&lt;span style="display:flex;">&lt;span>- &lt;span style="color:#f92672">targets&lt;/span>: [&lt;span style="color:#e6db74">&amp;#39;localhost:9090&amp;#39;&lt;/span>] &lt;span style="color:#75715e"># 监控目标&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">labels&lt;/span>: &lt;span style="color:#75715e"># 配置标签&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">server&lt;/span>: &lt;span style="color:#ae81ff">local &lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>Prometheus-AlertManager警告管理搭建与配置</title><link>https://blog.51ai.vip/posts/prometheus-alertmanager%E8%AD%A6%E5%91%8A%E7%AE%A1%E7%90%86%E6%90%AD%E5%BB%BA%E4%B8%8E%E9%85%8D%E7%BD%AE/</link><pubDate>Sat, 19 Oct 2019 09:40:15 +0000</pubDate><guid>https://blog.51ai.vip/posts/prometheus-alertmanager%E8%AD%A6%E5%91%8A%E7%AE%A1%E7%90%86%E6%90%AD%E5%BB%BA%E4%B8%8E%E9%85%8D%E7%BD%AE/</guid><description>&lt;h2 id="alertmanager">AlertManager&lt;/h2>
&lt;blockquote>
&lt;p>AlertManager处理由客户端应用程序（如Prometheus服务器）发送的警报。
它负责重复数据消除、分组，并将它们路由到正确的接收器集成（如电子邮件、PagerDuty或OpsGenie）。
它还负责消除和抑制警报。&lt;/p>&lt;/blockquote>
&lt;p>通过翻译官方文档可以了解到,AlertManager是负责为Prometheus(本身不会发送警报)发送警报的工具.
AlertManager不是简单发送警报,可以消除重复警报,分组,抑制警报功能.并支持多接收器.&lt;/p>
&lt;p>Prometheus-&amp;gt;触发定义的警报规则-&amp;gt;AlertManager-&amp;gt;发送警报到指定通知渠道.&lt;/p>
&lt;p>为了能让Prometheus发送警报,我们需要:&lt;/p>
&lt;ol>
&lt;li>搭建AlertManager服务.&lt;/li>
&lt;li>定义AlertManager通知配置.&lt;/li>
&lt;li>定义Prometheus警报规则并引入.&lt;/li>
&lt;li>测试警报.&lt;/li>
&lt;li>定义通知模板.&lt;/li>
&lt;/ol>
&lt;h2 id="定义alertmanager通知配置">定义AlertManager通知配置&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-yaml" data-lang="yaml">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">global&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">smtp_smarthost&lt;/span>: &lt;span style="color:#e6db74">&amp;#39;smtp.163.com:25&amp;#39;&lt;/span> &lt;span style="color:#75715e"># 邮箱smtp服务器代理&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">smtp_from&lt;/span>: &lt;span style="color:#e6db74">&amp;#39;shitu-0071@163.com&amp;#39;&lt;/span> &lt;span style="color:#75715e"># 发送邮箱名称&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">resolve_timeout&lt;/span>: &lt;span style="color:#ae81ff">5m &lt;/span> &lt;span style="color:#75715e"># 处理超时时间，默认为5min&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">smtp_auth_username&lt;/span>: &lt;span style="color:#e6db74">&amp;#39;shitu-0071@163.com&amp;#39;&lt;/span> &lt;span style="color:#75715e"># 邮箱帐户&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">smtp_auth_password&lt;/span>: &lt;span style="color:#e6db74">&amp;#39;******&amp;#39;&lt;/span> &lt;span style="color:#75715e"># 邮箱授权码(注意是授权码,不知道自己查一下)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">wechat_api_url&lt;/span>: &lt;span style="color:#e6db74">&amp;#39;https://qyapi.weixin.qq.com/cgi-bin/&amp;#39;&lt;/span> &lt;span style="color:#75715e"># 企业微信地址&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># 定义模板信心&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">templates&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#e6db74">&amp;#39;template/*.tmpl&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># 定义路由树信息&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">route&lt;/span>: 
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">group_by&lt;/span>: [&lt;span style="color:#e6db74">&amp;#39;alertname&amp;#39;&lt;/span>, &lt;span style="color:#e6db74">&amp;#39;cluster&amp;#39;&lt;/span>, &lt;span style="color:#e6db74">&amp;#39;service&amp;#39;&lt;/span>] &lt;span style="color:#75715e"># 报警分组依据,设置后会按照设定值分组,例如instance,alertname等&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># 同标签警告会在作为一组警报发送&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">group_wait&lt;/span>: &lt;span style="color:#ae81ff">10s &lt;/span> &lt;span style="color:#75715e"># 组内等待时间,触发阈值后,XXs后发送本组警报&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">group_interval&lt;/span>: &lt;span style="color:#ae81ff">10s &lt;/span> &lt;span style="color:#75715e"># 每个组之前间隔时间(group_by设定的值划分的组)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">repeat_interval&lt;/span>: &lt;span style="color:#ae81ff">1m &lt;/span> &lt;span style="color:#75715e"># 重复发送警报的周期&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">(对于email配置中，此项不可以设置过低，否则将会由于邮件发送太多频繁，被smtp服务器拒绝)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">receiver&lt;/span>: &lt;span style="color:#e6db74">&amp;#39;email&amp;#39;&lt;/span> &lt;span style="color:#75715e"># 发送警报的接收者的名称&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># 以下receivers name的名称&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">routes&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#f92672">match&lt;/span>: &lt;span style="color:#75715e"># 普通匹配&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">serverity&lt;/span>: &lt;span style="color:#ae81ff">critical &lt;/span> &lt;span style="color:#75715e"># 警告级别critical&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">receiver&lt;/span>: &lt;span style="color:#ae81ff">email &lt;/span> &lt;span style="color:#75715e"># 通过邮件发送&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#f92672">match_re&lt;/span>: &lt;span style="color:#75715e"># 正则匹配&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">severity&lt;/span>: &lt;span style="color:#ae81ff">^(warning)$ &lt;/span> &lt;span style="color:#75715e"># 匹配警告级别为warning的&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">receiver&lt;/span>: &lt;span style="color:#ae81ff">wechat &lt;/span> &lt;span style="color:#75715e"># 通过微信发送告警&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#f92672">receiver&lt;/span>: &lt;span style="color:#ae81ff">along &lt;/span> &lt;span style="color:#75715e"># 定义接收者&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">match&lt;/span>: &lt;span style="color:#75715e"># 匹配&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">severity&lt;/span>: &lt;span style="color:#ae81ff">test &lt;/span> &lt;span style="color:#75715e"># 等级为test&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># 定义警报接收者信息&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">receivers&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#f92672">name&lt;/span>: &lt;span style="color:#e6db74">&amp;#39;email&amp;#39;&lt;/span> &lt;span style="color:#75715e"># 警报&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">email_configs&lt;/span>: &lt;span style="color:#75715e"># 邮箱配置&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#f92672">to&lt;/span>: &lt;span style="color:#e6db74">&amp;#39;******@163.com&amp;#39;&lt;/span> &lt;span style="color:#75715e"># 接收警报的email配置&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">html&lt;/span>: &lt;span style="color:#e6db74">&amp;#39;{{ template &amp;#34;test.html&amp;#34; . }}&amp;#39;&lt;/span> &lt;span style="color:#75715e"># 设定邮箱的内容模板&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">headers&lt;/span>: { &lt;span style="color:#f92672">Subject&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;[WARN] 报警邮件&amp;#34;&lt;/span>} &lt;span style="color:#75715e"># 接收邮件的标题&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">webhook_configs&lt;/span>: &lt;span style="color:#75715e"># webhook配置&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#f92672">url&lt;/span>: &lt;span style="color:#e6db74">&amp;#39;http://127.0.0.1:5001&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">send_resolved&lt;/span>: &lt;span style="color:#66d9ef">true&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#f92672">name&lt;/span>: &lt;span style="color:#e6db74">&amp;#39;wechat&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">wechat_configs&lt;/span>: &lt;span style="color:#75715e"># 企业微信报警配置&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#f92672">send_resolved&lt;/span>: &lt;span style="color:#66d9ef">true&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">to_party&lt;/span>: &lt;span style="color:#e6db74">&amp;#39;1&amp;#39;&lt;/span> &lt;span style="color:#75715e"># 接收组的id&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">agent_id&lt;/span>: &lt;span style="color:#e6db74">&amp;#39;1000002&amp;#39;&lt;/span> &lt;span style="color:#75715e"># (企业微信--&amp;gt;自定应用--&amp;gt;AgentId)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">corp_id&lt;/span>: &lt;span style="color:#e6db74">&amp;#39;******&amp;#39;&lt;/span> &lt;span style="color:#75715e"># 企业信息(我的企业--&amp;gt;CorpId[在底部])&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">api_secret&lt;/span>: &lt;span style="color:#e6db74">&amp;#39;******&amp;#39;&lt;/span> &lt;span style="color:#75715e"># 企业微信(企业微信--&amp;gt;自定应用--&amp;gt;Secret)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">message&lt;/span>: &lt;span style="color:#e6db74">&amp;#39;{{ template &amp;#34;test_wechat.html&amp;#34; . }}&amp;#39;&lt;/span> &lt;span style="color:#75715e"># 发送消息模板的设定&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># 一个inhibition规则是在与另一组匹配器匹配的警报存在的条件下，&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># 使匹配一组匹配器的警报失效的规则。两个警报必须具有一组相同的标签。 &lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">inhibit_rules&lt;/span>: 
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#f92672">source_match&lt;/span>: 
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">severity&lt;/span>: &lt;span style="color:#e6db74">&amp;#39;critical&amp;#39;&lt;/span> 
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">target_match&lt;/span>: 
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">severity&lt;/span>: &lt;span style="color:#e6db74">&amp;#39;critical&amp;#39;&lt;/span> 
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">equal&lt;/span>: [&lt;span style="color:#e6db74">&amp;#39;instance&amp;#39;&lt;/span>]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># 已经发送的告警通知匹配到target_match和target_match_re规则，&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># 再有新的告警规则如果满足source_match&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># 或者定义的匹配规则，并且已发送的告警与新产生的告警中equal定义的标签完全相同，&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># 则启动抑制机制，新的告警不会发送。&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;hr>
&lt;p>以下是官方文档配置翻译的文档.供参考具体详细的配置介绍.不细看先略过到下个步骤.&lt;/p></description></item><item><title>Prometueus.yml配置文件说明</title><link>https://blog.51ai.vip/posts/prometueus-yml%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E8%AF%B4%E6%98%8E/</link><pubDate>Wed, 09 Oct 2019 15:20:58 +0000</pubDate><guid>https://blog.51ai.vip/posts/prometueus-yml%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E8%AF%B4%E6%98%8E/</guid><description>&lt;h2 id="整体配置">整体配置&lt;/h2>
&lt;p>prometueus.yml 配置文件注解与说明&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-yaml" data-lang="yaml">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">global&lt;/span>: &lt;span style="color:#75715e"># 全局配置&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">scrape_interval&lt;/span>: &lt;span style="color:#ae81ff">15s &lt;/span> &lt;span style="color:#75715e"># 默认值为 1m，用于设置每次数据收集的间隔&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">scrape_timeout&lt;/span>: &lt;span style="color:#ae81ff">10s &lt;/span> &lt;span style="color:#75715e"># 默认10s,收集超时时间&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">evaluation_interval&lt;/span>: &lt;span style="color:#ae81ff">15s &lt;/span> &lt;span style="color:#75715e"># 记录规则/告警的执行周期 默认1m&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">external_labels&lt;/span>: &lt;span style="color:#75715e"># 时间序列和警告与外部通信(远程存储/警报灯)时用的外部标签&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">monitor&lt;/span>: &lt;span style="color:#e6db74">&amp;#39;ctmonitor&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">rule_files&lt;/span>: &lt;span style="color:#75715e"># 指定告警规则文件&amp;amp;记录文件&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#e6db74">&amp;#34;/usr/local/prometheus/rules.yml&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">alerting&lt;/span>: &lt;span style="color:#75715e"># 告警管理配置&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">alert_relable_configs&lt;/span>: &lt;span style="color:#75715e"># 修改告警内容&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - 
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">alertmanagers&lt;/span>: &lt;span style="color:#75715e"># 告警管理起配置&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#f92672">static_configs&lt;/span>: &lt;span style="color:#75715e"># 静态配置&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#f92672">targets&lt;/span>: &lt;span style="color:#75715e"># 警告器地址&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#ae81ff">172.16.23.12&lt;/span>:&lt;span style="color:#ae81ff">9093&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># 用于配置 scrape 的 endpoint 配置需要 scrape 的 targets 以及相应的参数&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># 抓取(pull)，即监控目标配置。默认只有主机本身的监控配置 &lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">scrape_configs&lt;/span>: &lt;span style="color:#75715e"># 抓取配置选项&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>- &lt;span style="color:#f92672">job_name&lt;/span>: &lt;span style="color:#ae81ff">prometheus &lt;/span> &lt;span style="color:#75715e"># 默认情况下分配给刮削度量的作业名称。&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">scrape_interval&lt;/span>: &lt;span style="color:#ae81ff">5s &lt;/span> &lt;span style="color:#75715e"># 从这项工作中获取目标的频率。&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">scrape_timeout&lt;/span>: &lt;span style="color:#ae81ff">3s &lt;/span> &lt;span style="color:#75715e"># 每次获取超时时间&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">honor_timestamps&lt;/span>: &lt;span style="color:#66d9ef">true&lt;/span> &lt;span style="color:#75715e"># 默认false, 在获取时是否使用当前的时间戳&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">metrics_path&lt;/span>: &lt;span style="color:#ae81ff">/metrics &lt;/span> &lt;span style="color:#75715e"># 从目标获取度量的http资源路径。&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">scheme&lt;/span>: &lt;span style="color:#ae81ff">http &lt;/span> &lt;span style="color:#75715e"># &lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">static_configs&lt;/span>: &lt;span style="color:#75715e"># 为此作业标记的静态配置目标的列表。&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#f92672">targets&lt;/span>: &lt;span style="color:#75715e"># 目监控标&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#ae81ff">172.16.23.12&lt;/span>:&lt;span style="color:#ae81ff">9090&lt;/span> &lt;span style="color:#75715e"># 设备地址+端口&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>- &lt;span style="color:#f92672">job_name&lt;/span>: &lt;span style="color:#e6db74">&amp;#39;snmp-10.0.0.1&amp;#39;&lt;/span> 
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">scrape_interval&lt;/span>: &lt;span style="color:#ae81ff">30s&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">scrape_timeout&lt;/span>: &lt;span style="color:#ae81ff">20s&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">static_configs&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#f92672">targets&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#ae81ff">10.0.0.1&lt;/span> &lt;span style="color:#75715e"># SNMP设备,端口默认5060&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">metrics_path&lt;/span>: &lt;span style="color:#ae81ff">/snmp&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">params&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">module&lt;/span>: [&lt;span style="color:#ae81ff">if_mib]&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">relabel_configs&lt;/span>: &lt;span style="color:#75715e"># 重定义标签&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#f92672">source_labels&lt;/span>: [&lt;span style="color:#ae81ff">__address__] &lt;/span> &lt;span style="color:#75715e"># 需要修改的标签&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">target_label&lt;/span>: &lt;span style="color:#ae81ff">__param_target &lt;/span> &lt;span style="color:#75715e"># 改成的标签&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#f92672">source_labels&lt;/span>: [&lt;span style="color:#ae81ff">__param_target]&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">target_label&lt;/span>: &lt;span style="color:#ae81ff">instance&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#f92672">target_label&lt;/span>: &lt;span style="color:#ae81ff">__address__&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">replacement&lt;/span>: &lt;span style="color:#ae81ff">172.16.23.12&lt;/span>:&lt;span style="color:#ae81ff">9117&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="各部分详解">各部分详解&lt;/h2>
&lt;hr>
&lt;p>部分官方文档的译文&lt;/p></description></item><item><title>Prometheus+Grafana安装搭建</title><link>https://blog.51ai.vip/posts/prometheus-grafana%E5%AE%89%E8%A3%85%E6%90%AD%E5%BB%BA/</link><pubDate>Wed, 28 Aug 2019 16:23:05 +0000</pubDate><guid>https://blog.51ai.vip/posts/prometheus-grafana%E5%AE%89%E8%A3%85%E6%90%AD%E5%BB%BA/</guid><description>&lt;h2 id="介绍">介绍&lt;/h2>
&lt;blockquote>
&lt;p>Prometheus是由SoundCloud开发的开源监控报警系统和时序列数据库(TSDB)。Prometheus使用Go语言开发，是Google BorgMon监控系统的开源版本。
2016年由Google发起Linux基金会旗下的原生云基金会(Cloud Native Computing Foundation), 将Prometheus纳入其下第二大开源项目。Prometheus目前在开源社区相当活跃。
Prometheus和Heapster(Heapster是K8S的一个子项目，用于获取集群的性能数据。)相比功能更完善、更全面。Prometheus性能也足够支撑上万台规模的集群。&lt;/p>&lt;/blockquote>
&lt;blockquote>
&lt;p>Prometheus的特点:&lt;/p>
&lt;ol>
&lt;li>多维度数据模型。&lt;/li>
&lt;li>灵活的查询语言。&lt;/li>
&lt;li>不依赖分布式存储，单个服务器节点是自主的。&lt;/li>
&lt;li>通过基于HTTP的pull方式采集时序数据。&lt;/li>
&lt;li>可以通过中间网关进行时序列数据推送。&lt;/li>
&lt;li>通过服务发现或者静态配置来发现目标服务对象。&lt;/li>
&lt;li>支持多种多样的图表和界面展示，比如Grafana等。&lt;/li>
&lt;/ol>&lt;/blockquote>
&lt;h2 id="架构图">架构图&lt;/h2>
&lt;p>&lt;img src="https://t1.picb.cc/uploads/2019/08/29/gjevPW.png" alt="结构图">&lt;/p>
&lt;h2 id="prometheus服务大致过程">Prometheus服务大致过程：&lt;/h2>
&lt;ul>
&lt;li>
&lt;p>Prometheus 定时去目标上抓取metrics(指标)数据，每个抓取目标需要暴露一个http服务的接口给它定时抓取。Prometheus支持通过配置文件、文本文件、Zookeeper、Consul、DNS SRV Lookup等方式指定抓取目标。Prometheus采用PULL的方式进行监控，即服务器可以直接通过目标PULL数据或者间接地通过中间网关来Push数据。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Prometheus在本地存储抓取的所有数据，并通过一定规则进行清理和整理数据，并把得到的结果存储到新的时间序列中。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Prometheus通过PromQL和其他API可视化地展示收集的数据。Prometheus支持很多方式的图表可视化，例如Grafana、自带的Promdash以及自身提供的模版引擎等等。Prometheus还提供HTTP API的查询方式，自定义所需要的输出。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>PushGateway支持Client主动推送metrics到PushGateway，而Prometheus只是定时去Gateway上抓取数据。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Alertmanager是独立于Prometheus的一个组件，可以支持Prometheus的查询语句，提供十分灵活的报警方式。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Prometheus 支持通过SNMP协议获取mertics数据.通过配置job,利用snmp_export读取设备监控信息.&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h2 id="指标metric类型">指标(Metric)类型&lt;/h2>
&lt;ul>
&lt;li>&lt;strong>Counter&lt;/strong> 计数器,从数据0开始累计计算. 理想状态会永远增长. 累计计算请求次数等&lt;/li>
&lt;li>&lt;strong>Gauges&lt;/strong> 瞬时状态的值. 可以任意变化的数值，适用 CPU 使用率 温度等&lt;/li>
&lt;li>&lt;strong>Histogram&lt;/strong> 对一段时间范围内数据进行采样，并对所有数值求和与统计数量、柱状图. 某个时间对某个度量值，分组，一段时间http相应大小，请求耗时的时间。&lt;/li>
&lt;li>&lt;strong>Summary&lt;/strong> 同样产生多个指标，分别带有后缀_bucket(仅histogram)、_sum、_count&lt;/li>
&lt;/ul>
&lt;blockquote>
&lt;p>Histogram和Summary都可以获取分位数。
通过Histogram获得分位数，要将直方图指标数据收集prometheus中， 然后用prometheus的查询函数&lt;a href="https://prometheus.io/docs/prometheus/latest/querying/functions/#histogram_quantile">histogram_quantile()&lt;/a>计算出来。 Summary则是在应用程序中直接计算出了分位数。
&lt;a href="https://prometheus.io/docs/practices/histograms/">Histograms and summaries&lt;/a>中阐述了两者的区别，特别是Summary的的分位数不能被聚合。
注意，这个不能聚合不是说功能上不支持，而是说对分位数做聚合操作通常是没有意义的。
&lt;a href="https://latencytipoftheday.blogspot.com/2014/06/latencytipoftheday-you-cant-average.html">LatencyTipOfTheDay: You can’t average percentiles. Period&lt;/a>中对“分位数”不能被相加平均的做了很详细的说明：分位数本身是用来切分数据的，它们的平均数没有同样的分位效果。&lt;/p>&lt;/blockquote>
&lt;p>主要我们监控用到最上面两种,下面两种类型目前我没有接触,上面这段文字与介绍引用自&lt;a href="https://www.lijiaocn.com/%E9%A1%B9%E7%9B%AE/2018/08/03/prometheus-usage.html#metric%E7%B1%BB%E5%9E%8B">lijiaocn&lt;/a>&lt;/p>
&lt;h2 id="安装prometheus">安装Prometheus&lt;/h2>
&lt;p>&lt;strong>本次搭建利用docker方式.整体搭建完成需要两个容器.暂不配置告警相关,只做监控数据&lt;/strong>&lt;/p>
&lt;h3 id="前提">前提&lt;/h3>
&lt;ul>
&lt;li>
&lt;p>搭建位置: &lt;em>/home/aLong/prometheus/&lt;/em>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>环境:docker19.03.1 需要指定版本请查阅官方文档.&lt;/p></description></item></channel></rss>