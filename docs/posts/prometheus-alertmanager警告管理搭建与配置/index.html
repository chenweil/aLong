<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="generator" content="Hugo 0.86.0" />
  
  <meta name="description" content="AlertManager  AlertManager处理由客户端应用程序（如Prometheus服务器）发送的警报。 它负责重复数据消除、分组，并将它们路由到正确的接收器集成（如电子邮件、PagerDuty或OpsGenie）。 它还负责消除和抑制警报。
 通过翻译官方文档可以了解到,AlertManager是负责为Prometheus(本身不会发送警报)发送警报的工具. AlertManager不是简单发送警报,可以消除重复警报,分组,抑制警报功能.并支持多接收器.
Prometheus-&gt;触发定义的警报规则-&gt;AlertManager-&gt;发送警报到指定通知渠道.
为了能让Prometheus发送警报,我们需要:
 搭建AlertManager服务. 定义AlertManager通知配置. 定义Prometheus警报规则并引入. 测试警报. 定义通知模板.  定义AlertManager通知配置 global:smtp_smarthost:&#39;smtp.163.com:25&#39;# 邮箱smtp服务器代理smtp_from:&#39;shitu-0071@163.com&#39;# 发送邮箱名称resolve_timeout:5m # 处理超时时间，默认为5minsmtp_auth_username:&#39;shitu-0071@163.com&#39;# 邮箱帐户smtp_auth_password:&#39;******&#39;# 邮箱授权码(注意是授权码,不知道自己查一下)wechat_api_url:&#39;https://qyapi.weixin.qq.com/cgi-bin/&#39;# 企业微信地址# 定义模板信心templates:- &#39;template/*.tmpl&#39;# 定义路由树信息route:group_by:[&#39;alertname&#39;,&#39;cluster&#39;,&#39;service&#39;]# 报警分组依据,设置后会按照设定值分组,例如instance,alertname等# 同标签警告会在作为一组警报发送group_wait:10s # 组内等待时间,触发阈值后,XXs后发送本组警报group_interval:10s # 每个组之前间隔时间(group_by设定的值划分的组)repeat_interval:1m # 重复发送警报的周期(对于email配置中，此项不可以设置过低，否则将会由于邮件发送太多频繁，被smtp服务器拒绝)receiver:&#39;email&#39;# 发送警报的接收者的名称# 以下receivers name的名称routes:- match:# 普通匹配serverity:critical # 警告级别criticalreceiver:email # 通过邮件发送- match_re:# 正则匹配severity:^(warning)$ # 匹配警告级别为warning的receiver:wechat # 通过微信发送告警- receiver:along # 定义接收者match:# 匹配severity:test # 等级为test# 定义警报接收者信息receivers:- name:&#39;email&#39;# 警报email_configs:# 邮箱配置- to:&#39;******@163.com&#39;# 接收警报的email配置html:&#39;{{ template &#34;test.html&#34; . }}&#39;# 设定邮箱的内容模板headers:{Subject:&#34;[WARN] 报警邮件&#34;}# 接收邮件的标题webhook_configs:# webhook配置- url:&#39;http://127.">
  <link rel="stylesheet" href="https://blog.51ai.vip/aLong/css/normalize.css">
  <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
  
  
  
  <link rel="stylesheet" href="https://blog.51ai.vip/aLong/css/cayman.ea0e967413f3851071cc8ace3621bc4205fe8fa79b2abe3d7bf94ff2841f0d47.css">
  
  
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.2/dist/katex.min.css" integrity="sha384-yFRtMMDnQtDRO8rLpMIKrtPCD5jdktao2TV19YiZYWMDkUR5GQZR/NOVTdquEx1j" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.2/dist/katex.min.js" integrity="sha384-9Nhn55MVVN0/4OFx7EE5kpFBPsEMZxKTCnA+4fqDmg12eCTqGi6+BB2LjY8brQxJ" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.2/dist/contrib/auto-render.min.js" integrity="sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI" crossorigin="anonymous" onload="renderMathInElement(document.body);"></script>

  <title>Prometheus-AlertManager警告管理搭建与配置 | aLong blog</title>
</head>

<body>
  <section class="page-header">
  <h1 class="project-name">
    aLong
  </h1>
  <h2 class="project-tagline">
    Hello world
  </h2>
  <nav>
    
    
      
      
      
      
      <a href="/aLong/" class="btn">Blog</a>
    
      
      
      
      
      <a href="/aLong/tags/" class="btn">Tags</a>
    
  </nav>
</section>

  <section class="main-content">
    
  <h1>Prometheus-AlertManager警告管理搭建与配置</h1>
  <h2 id="alertmanager">AlertManager</h2>
<blockquote>
<p>AlertManager处理由客户端应用程序（如Prometheus服务器）发送的警报。
它负责重复数据消除、分组，并将它们路由到正确的接收器集成（如电子邮件、PagerDuty或OpsGenie）。
它还负责消除和抑制警报。</p>
</blockquote>
<p>通过翻译官方文档可以了解到,AlertManager是负责为Prometheus(本身不会发送警报)发送警报的工具.
AlertManager不是简单发送警报,可以消除重复警报,分组,抑制警报功能.并支持多接收器.</p>
<p>Prometheus-&gt;触发定义的警报规则-&gt;AlertManager-&gt;发送警报到指定通知渠道.</p>
<p>为了能让Prometheus发送警报,我们需要:</p>
<ol>
<li>搭建AlertManager服务.</li>
<li>定义AlertManager通知配置.</li>
<li>定义Prometheus警报规则并引入.</li>
<li>测试警报.</li>
<li>定义通知模板.</li>
</ol>
<h2 id="定义alertmanager通知配置">定义AlertManager通知配置</h2>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#008000;font-weight:bold">global</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">smtp_smarthost</span>:<span style="color:#bbb"> </span><span style="color:#ba2121">&#39;smtp.163.com:25&#39;</span><span style="color:#bbb">               </span><span style="color:#408080;font-style:italic"># 邮箱smtp服务器代理</span><span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">smtp_from</span>:<span style="color:#bbb"> </span><span style="color:#ba2121">&#39;shitu-0071@163.com&#39;</span><span style="color:#bbb">                 </span><span style="color:#408080;font-style:italic"># 发送邮箱名称</span><span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">resolve_timeout</span>:<span style="color:#bbb"> </span>5m                            <span style="color:#bbb"> </span><span style="color:#408080;font-style:italic"># 处理超时时间，默认为5min</span><span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">smtp_auth_username</span>:<span style="color:#bbb"> </span><span style="color:#ba2121">&#39;shitu-0071@163.com&#39;</span><span style="color:#bbb">        </span><span style="color:#408080;font-style:italic"># 邮箱帐户</span><span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">smtp_auth_password</span>:<span style="color:#bbb"> </span><span style="color:#ba2121">&#39;******&#39;</span><span style="color:#bbb">                    </span><span style="color:#408080;font-style:italic"># 邮箱授权码(注意是授权码,不知道自己查一下)</span><span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">wechat_api_url</span>:<span style="color:#bbb"> </span><span style="color:#ba2121">&#39;https://qyapi.weixin.qq.com/cgi-bin/&#39;</span><span style="color:#bbb">   </span><span style="color:#408080;font-style:italic"># 企业微信地址</span><span style="color:#bbb">
</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#408080;font-style:italic"># 定义模板信心</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">templates</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span>- <span style="color:#ba2121">&#39;template/*.tmpl&#39;</span><span style="color:#bbb">
</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#408080;font-style:italic"># 定义路由树信息</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">route</span>:<span style="color:#bbb">   
</span><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">group_by</span>:<span style="color:#bbb"> </span>[<span style="color:#ba2121">&#39;alertname&#39;</span>,<span style="color:#bbb"> </span><span style="color:#ba2121">&#39;cluster&#39;</span>,<span style="color:#bbb"> </span><span style="color:#ba2121">&#39;service&#39;</span>]<span style="color:#bbb">        </span><span style="color:#408080;font-style:italic"># 报警分组依据,设置后会按照设定值分组,例如instance,alertname等</span><span style="color:#bbb">
</span><span style="color:#bbb">                                                       </span><span style="color:#408080;font-style:italic"># 同标签警告会在作为一组警报发送</span><span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">group_wait</span>:<span style="color:#bbb"> </span>10s                                     <span style="color:#bbb"> </span><span style="color:#408080;font-style:italic"># 组内等待时间,触发阈值后,XXs后发送本组警报</span><span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">group_interval</span>:<span style="color:#bbb"> </span>10s                                 <span style="color:#bbb"> </span><span style="color:#408080;font-style:italic"># 每个组之前间隔时间(group_by设定的值划分的组)</span><span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">repeat_interval</span>:<span style="color:#bbb"> </span>1m                                 <span style="color:#bbb"> </span><span style="color:#408080;font-style:italic"># 重复发送警报的周期</span><span style="color:#bbb">
</span><span style="color:#bbb">  </span>(对于email配置中，此项不可以设置过低，否则将会由于邮件发送太多频繁，被smtp服务器拒绝)<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">receiver</span>:<span style="color:#bbb"> </span><span style="color:#ba2121">&#39;email&#39;</span><span style="color:#bbb">                                    </span><span style="color:#408080;font-style:italic"># 发送警报的接收者的名称</span><span style="color:#bbb">
</span><span style="color:#bbb">                                                       </span><span style="color:#408080;font-style:italic"># 以下receivers name的名称</span><span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">routes</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span>- <span style="color:#008000;font-weight:bold">match</span>:<span style="color:#bbb">                      </span><span style="color:#408080;font-style:italic"># 普通匹配</span><span style="color:#bbb">
</span><span style="color:#bbb">      </span><span style="color:#008000;font-weight:bold">serverity</span>:<span style="color:#bbb"> </span>critical      <span style="color:#bbb"> </span><span style="color:#408080;font-style:italic"># 警告级别critical</span><span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">receiver</span>:<span style="color:#bbb"> </span>email            <span style="color:#bbb"> </span><span style="color:#408080;font-style:italic"># 通过邮件发送</span><span style="color:#bbb">
</span><span style="color:#bbb">  </span>- <span style="color:#008000;font-weight:bold">match_re</span>:<span style="color:#bbb">                   </span><span style="color:#408080;font-style:italic"># 正则匹配</span><span style="color:#bbb">
</span><span style="color:#bbb">      </span><span style="color:#008000;font-weight:bold">severity</span>:<span style="color:#bbb"> </span>^(warning)$    <span style="color:#bbb"> </span><span style="color:#408080;font-style:italic"># 匹配警告级别为warning的</span><span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">receiver</span>:<span style="color:#bbb"> </span>wechat           <span style="color:#bbb"> </span><span style="color:#408080;font-style:italic"># 通过微信发送告警</span><span style="color:#bbb">
</span><span style="color:#bbb">  </span>- <span style="color:#008000;font-weight:bold">receiver</span>:<span style="color:#bbb"> </span>along            <span style="color:#bbb"> </span><span style="color:#408080;font-style:italic"># 定义接收者</span><span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">match</span>:<span style="color:#bbb">                      </span><span style="color:#408080;font-style:italic"># 匹配</span><span style="color:#bbb">
</span><span style="color:#bbb">      </span><span style="color:#008000;font-weight:bold">severity</span>:<span style="color:#bbb"> </span>test           <span style="color:#bbb"> </span><span style="color:#408080;font-style:italic"># 等级为test</span><span style="color:#bbb">
</span><span style="color:#bbb">
</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#408080;font-style:italic"># 定义警报接收者信息</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">receivers</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span>- <span style="color:#008000;font-weight:bold">name</span>:<span style="color:#bbb"> </span><span style="color:#ba2121">&#39;email&#39;</span><span style="color:#bbb">               </span><span style="color:#408080;font-style:italic"># 警报</span><span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">email_configs</span>:<span style="color:#bbb">              </span><span style="color:#408080;font-style:italic"># 邮箱配置</span><span style="color:#bbb">
</span><span style="color:#bbb">    </span>- <span style="color:#008000;font-weight:bold">to</span>:<span style="color:#bbb"> </span><span style="color:#ba2121">&#39;******@163.com&#39;</span><span style="color:#bbb">      </span><span style="color:#408080;font-style:italic"># 接收警报的email配置</span><span style="color:#bbb">
</span><span style="color:#bbb">      </span><span style="color:#008000;font-weight:bold">html</span>:<span style="color:#bbb"> </span><span style="color:#ba2121">&#39;{{ template &#34;test.html&#34; . }}&#39;</span><span style="color:#bbb">      </span><span style="color:#408080;font-style:italic"># 设定邮箱的内容模板</span><span style="color:#bbb">
</span><span style="color:#bbb">      </span><span style="color:#008000;font-weight:bold">headers</span>:<span style="color:#bbb"> </span>{<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">Subject</span>:<span style="color:#bbb"> </span><span style="color:#ba2121">&#34;[WARN] 报警邮件&#34;</span>}<span style="color:#bbb">     </span><span style="color:#408080;font-style:italic"># 接收邮件的标题</span><span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">webhook_configs</span>:<span style="color:#bbb"> </span><span style="color:#408080;font-style:italic"># webhook配置</span><span style="color:#bbb">
</span><span style="color:#bbb">    </span>- <span style="color:#008000;font-weight:bold">url</span>:<span style="color:#bbb"> </span><span style="color:#ba2121">&#39;http://127.0.0.1:5001&#39;</span><span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">send_resolved</span>:<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">true</span><span style="color:#bbb">
</span><span style="color:#bbb">
</span><span style="color:#bbb">  </span>- <span style="color:#008000;font-weight:bold">name</span>:<span style="color:#bbb"> </span><span style="color:#ba2121">&#39;wechat&#39;</span><span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">wechat_configs</span>:<span style="color:#bbb"> </span><span style="color:#408080;font-style:italic"># 企业微信报警配置</span><span style="color:#bbb">
</span><span style="color:#bbb">    </span>- <span style="color:#008000;font-weight:bold">send_resolved</span>:<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">true</span><span style="color:#bbb">
</span><span style="color:#bbb">      </span><span style="color:#008000;font-weight:bold">to_party</span>:<span style="color:#bbb"> </span><span style="color:#ba2121">&#39;1&#39;</span><span style="color:#bbb"> </span><span style="color:#408080;font-style:italic"># 接收组的id</span><span style="color:#bbb">
</span><span style="color:#bbb">      </span><span style="color:#008000;font-weight:bold">agent_id</span>:<span style="color:#bbb"> </span><span style="color:#ba2121">&#39;1000002&#39;</span><span style="color:#bbb"> </span><span style="color:#408080;font-style:italic"># (企业微信--&gt;自定应用--&gt;AgentId)</span><span style="color:#bbb">
</span><span style="color:#bbb">      </span><span style="color:#008000;font-weight:bold">corp_id</span>:<span style="color:#bbb"> </span><span style="color:#ba2121">&#39;******&#39;</span><span style="color:#bbb"> </span><span style="color:#408080;font-style:italic"># 企业信息(我的企业--&gt;CorpId[在底部])</span><span style="color:#bbb">
</span><span style="color:#bbb">      </span><span style="color:#008000;font-weight:bold">api_secret</span>:<span style="color:#bbb"> </span><span style="color:#ba2121">&#39;******&#39;</span><span style="color:#bbb"> </span><span style="color:#408080;font-style:italic"># 企业微信(企业微信--&gt;自定应用--&gt;Secret)</span><span style="color:#bbb">
</span><span style="color:#bbb">      </span><span style="color:#008000;font-weight:bold">message</span>:<span style="color:#bbb"> </span><span style="color:#ba2121">&#39;{{ template &#34;test_wechat.html&#34; . }}&#39;</span><span style="color:#bbb"> </span><span style="color:#408080;font-style:italic"># 发送消息模板的设定</span><span style="color:#bbb">
</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#408080;font-style:italic"># 一个inhibition规则是在与另一组匹配器匹配的警报存在的条件下，</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#408080;font-style:italic"># 使匹配一组匹配器的警报失效的规则。两个警报必须具有一组相同的标签。 </span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">inhibit_rules</span>:<span style="color:#bbb"> 
</span><span style="color:#bbb">  </span>- <span style="color:#008000;font-weight:bold">source_match</span>:<span style="color:#bbb"> 
</span><span style="color:#bbb">     </span><span style="color:#008000;font-weight:bold">severity</span>:<span style="color:#bbb"> </span><span style="color:#ba2121">&#39;critical&#39;</span><span style="color:#bbb"> 
</span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">target_match</span>:<span style="color:#bbb"> 
</span><span style="color:#bbb">     </span><span style="color:#008000;font-weight:bold">severity</span>:<span style="color:#bbb"> </span><span style="color:#ba2121">&#39;critical&#39;</span><span style="color:#bbb"> 
</span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">equal</span>:<span style="color:#bbb"> </span>[<span style="color:#ba2121">&#39;instance&#39;</span>]<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#408080;font-style:italic"># 已经发送的告警通知匹配到target_match和target_match_re规则，</span><span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#408080;font-style:italic"># 再有新的告警规则如果满足source_match</span><span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#408080;font-style:italic"># 或者定义的匹配规则，并且已发送的告警与新产生的告警中equal定义的标签完全相同，</span><span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#408080;font-style:italic"># 则启动抑制机制，新的告警不会发送。</span><span style="color:#bbb">
</span></code></pre></div><hr>
<p>以下是官方文档配置翻译的文档.供参考具体详细的配置介绍.不细看先略过到下个步骤.</p>
<hr>
<!-- raw HTML omitted -->
<p>路由块定义路由树中的节点及其子节点。如果未设置，则其可选配置参数将从其父节点继承。
每个警报都在配置的顶级路由处进入路由树，该路由树必须与所有警报匹配（即没有任何配置的匹配器）。
然后它遍历子节点。如果continue设置为false，则在第一个匹配的子级之后停止。
如果匹配节点上的continue为true，则警报将继续与后续同级节点匹配。
如果警报与节点的任何子节点不匹配（没有匹配的子节点，或者不存在），则基于当前节点的配置参数来处理警报。</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#008000;font-weight:bold">[ receiver</span>:<span style="color:#bbb"> </span>&lt;string&gt; ]<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#408080;font-style:italic"># 用于将传入警报分组在一起的标签。 </span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#408080;font-style:italic"># 例如，针对cluster = A和alertname = LatencyHigh的多个警报将被分为一个组。</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#408080;font-style:italic"># 要按所有可能的标签进行汇总，请使用特殊值&#39;...&#39;作为唯一的标签名称，例如：group_by：[&#39;...&#39;]</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#408080;font-style:italic"># 这样可以有效地完全禁用聚合，并按原样传递所有警报。 </span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#408080;font-style:italic"># 除非您的警报量非常低或上游通知系统执行自己的分组，否则这不太可能是您想要的。</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">[ group_by</span>:<span style="color:#bbb"> </span><span style="color:#ba2121">&#39;[&#39;</span><span style="color:#bbb"> </span>&lt;labelname&gt;, ... &#39;]&#39; ]<span style="color:#bbb">
</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#408080;font-style:italic"># 警报是否应继续匹配后续的同级节点</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">[ continue</span>:<span style="color:#bbb"> </span>&lt;boolean&gt; | default = false ]<span style="color:#bbb">
</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#408080;font-style:italic"># 警报必须满足的一组相等匹配器才能匹配节点。</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">match</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">[ &lt;labelname&gt;</span>:<span style="color:#bbb"> </span>&lt;labelvalue&gt;, ... ]<span style="color:#bbb">
</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#408080;font-style:italic"># 警报必须满足以匹配节点的一组正则表达式匹配器。</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">match_re</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">[ &lt;labelname&gt;</span>:<span style="color:#bbb"> </span>&lt;regex&gt;, ... ]<span style="color:#bbb">
</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#408080;font-style:italic"># 最初等待为一组警报发送通知的时间。 </span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#408080;font-style:italic"># 允许等待禁止警报到达或为同一组收集更多初始警报。 （通常〜0秒到几分钟。）</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">[ group_wait</span>:<span style="color:#bbb"> </span>&lt;duration&gt; | default = 30s ]<span style="color:#bbb">
</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#408080;font-style:italic"># 发送有关新警报的通知之前要等待的时间，</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#408080;font-style:italic"># 该通知将添加到已为其发送了初始通知的一组警报中。 （通常〜5m或更多。）</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">[ group_interval</span>:<span style="color:#bbb"> </span>&lt;duration&gt; | default = 5m ]<span style="color:#bbb">
</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#408080;font-style:italic"># 如果已成功发送警报，则等待多长时间才能再次发送通知。 （通常〜3h或更长时间）。</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">[ repeat_interval</span>:<span style="color:#bbb"> </span>&lt;duration&gt; | default = 4h ]<span style="color:#bbb">
</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#408080;font-style:italic"># 零个或多个子路由。</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">routes</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span>[<span style="color:#bbb"> </span>- &lt;route&gt; ... ]<span style="color:#bbb">
</span></code></pre></div><p>&lt;inhibit_rule&gt;
当与另一组匹配器匹配的警报（源）存在时，禁止规则静默匹配匹配器集合的警报（目标）。
对于相等列表中的标签名称，目标和源警报必须具有相同的标签值。
从语义上讲，缺失的标签和空值的标签是一样的。
因此，如果源警报和目标警报中均缺少equal中列出的所有标签名称，则将应用抑制规则。
为了防止警报抑制自身，与规则的目标端和源端都匹配的警报不能被相同的警报（包括自身）抑制。
但是，我们建议选择目标和源匹配器时，警报不会同时匹配双方。这很容易推理，也不会引发这种特殊情况。</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#408080;font-style:italic"># 必须在警报中完成的匹配项才能被禁用</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">target_match</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">[ &lt;labelname&gt;</span>:<span style="color:#bbb"> </span>&lt;labelvalue&gt;, ... ]<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">target_match_re</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">[ &lt;labelname&gt;</span>:<span style="color:#bbb"> </span>&lt;regex&gt;, ... ]<span style="color:#bbb">
</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#408080;font-style:italic"># 匹配器必须具有一个或多个警报才能使抑制生效</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">source_match</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">[ &lt;labelname&gt;</span>:<span style="color:#bbb"> </span>&lt;labelvalue&gt;, ... ]<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">source_match_re</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">[ &lt;labelname&gt;</span>:<span style="color:#bbb"> </span>&lt;regex&gt;, ... ]<span style="color:#bbb">
</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#408080;font-style:italic"># 必须在源警报和目标警报中具有相等值的标签才能使抑制生效</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">[ equal</span>:<span style="color:#bbb"> </span><span style="color:#ba2121">&#39;[&#39;</span><span style="color:#bbb"> </span>&lt;labelname&gt;, ... &#39;]&#39; ]<span style="color:#bbb">
</span></code></pre></div><!-- raw HTML omitted -->
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#408080;font-style:italic"># 接收者的唯一名称</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">name</span>:<span style="color:#bbb"> </span>&lt;string&gt;<span style="color:#bbb">
</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#408080;font-style:italic"># 多个通知集成的配置(这里只列出三个其他请看官网)</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">email_configs</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span>[<span style="color:#bbb"> </span>- &lt;email_config&gt;, ... ]<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">webhook_configs</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span>[<span style="color:#bbb"> </span>- &lt;webhook_config&gt;, ... ]<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">wechat_configs</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span>[<span style="color:#bbb"> </span>- &lt;wechat_config&gt;, ... ]<span style="color:#bbb">
</span></code></pre></div><p>&lt;email_config&gt;</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#408080;font-style:italic"># 是否通知已解决的警报</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">[ send_resolved</span>:<span style="color:#bbb"> </span>&lt;boolean&gt; | default = false ]<span style="color:#bbb">
</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#408080;font-style:italic"># 要向其发送通知的电子邮件地址</span><span style="color:#bbb">
</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">to</span>:<span style="color:#bbb"> </span>&lt;tmpl_string&gt;<span style="color:#bbb">
</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#408080;font-style:italic"># 发件人地址</span><span style="color:#bbb">
</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">[ from</span>:<span style="color:#bbb"> </span>&lt;tmpl_string&gt; | default = global.smtp_from ]<span style="color:#bbb">
</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#408080;font-style:italic"># 发送电子邮件的SMTP主机</span><span style="color:#bbb">
</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">[ smarthost</span>:<span style="color:#bbb"> </span>&lt;string&gt; | default = global.smtp_smarthost ]<span style="color:#bbb">
</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#408080;font-style:italic"># 要标识到SMTP服务器的主机名</span><span style="color:#bbb">
</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">[ hello</span>:<span style="color:#bbb"> </span>&lt;string&gt; | default = global.smtp_hello ]<span style="color:#bbb">
</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#408080;font-style:italic"># SMTP身份验证信息.</span><span style="color:#bbb">
</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">[ auth_username</span>:<span style="color:#bbb"> </span>&lt;string&gt; | default = global.smtp_auth_username ]<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">[ auth_password</span>:<span style="color:#bbb"> </span>&lt;secret&gt; | default = global.smtp_auth_password ]<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">[ auth_secret</span>:<span style="color:#bbb"> </span>&lt;secret&gt; | default = global.smtp_auth_secret ]<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">[ auth_identity</span>:<span style="color:#bbb"> </span>&lt;string&gt; | default = global.smtp_auth_identity ]<span style="color:#bbb">
</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#408080;font-style:italic"># SMTP TLS要求</span><span style="color:#bbb">
</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">[ require_tls</span>:<span style="color:#bbb"> </span>&lt;bool&gt; | default = global.smtp_require_tls ]<span style="color:#bbb">
</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#408080;font-style:italic"># TLS配置</span><span style="color:#bbb">
</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">tls_config</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span>[<span style="color:#bbb"> </span>&lt;tls_config&gt; ]<span style="color:#bbb">
</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#408080;font-style:italic"># 电子邮件通知的HTML正文</span><span style="color:#bbb">
</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">[ html</span>:<span style="color:#bbb"> </span>&lt;tmpl_string&gt; | default = &#39;{{ template &#34;email.default.html&#34; . }}&#39; ]<span style="color:#bbb">
</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#408080;font-style:italic"># 电子邮件通知的正文</span><span style="color:#bbb">
</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">[ text</span>:<span style="color:#bbb"> </span>&lt;tmpl_string&gt; ]<span style="color:#bbb">
</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#408080;font-style:italic"># 更多标题电子邮件标题键/值对,重写通知实现以前设置的任何头</span><span style="color:#bbb">
</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#408080;font-style:italic"># 先前由通知实现设置的。</span><span style="color:#bbb">
</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">[ headers</span>:<span style="color:#bbb"> </span>{<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">&lt;string&gt;</span>:<span style="color:#bbb"> </span>&lt;tmpl_string&gt;, ... } ]<span style="color:#bbb">
</span><span style="color:#bbb">
</span></code></pre></div><p>&lt;webhook_config&gt;</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#408080;font-style:italic"># 是否通知已解决的警报</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">[ send_resolved</span>:<span style="color:#bbb"> </span>&lt;boolean&gt; | default = true ]<span style="color:#bbb">
</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#408080;font-style:italic"># 要向其发送HTTP POST请求的终结点</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">url</span>:<span style="color:#bbb"> </span>&lt;string&gt;<span style="color:#bbb">
</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#408080;font-style:italic"># http客户端的配置</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">[ http_config</span>:<span style="color:#bbb"> </span>&lt;http_config&gt; | default = global.http_config ]<span style="color:#bbb">
</span></code></pre></div><p>微信json 格式</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
  <span style="color:#008000;font-weight:bold">&#34;version&#34;</span>: <span style="color:#ba2121">&#34;4&#34;</span>,
  <span style="color:#008000;font-weight:bold">&#34;groupKey&#34;</span>: <span style="">&lt;string&gt;</span>,    <span style="">//</span> <span style="">识别警报组的密钥（例如重复数据消除）</span>
  <span style="color:#008000;font-weight:bold">&#34;status&#34;</span>: <span style="color:#ba2121">&#34;&lt;resolved|firing&gt;&#34;</span>,
  <span style="color:#008000;font-weight:bold">&#34;receiver&#34;</span>: <span style="">&lt;string&gt;</span>,
  <span style="color:#008000;font-weight:bold">&#34;groupLabels&#34;</span>: <span style="">&lt;object&gt;</span>,
  <span style="color:#008000;font-weight:bold">&#34;commonLabels&#34;</span>: <span style="">&lt;object&gt;</span>,
  <span style="color:#008000;font-weight:bold">&#34;commonAnnotations&#34;</span>: <span style="">&lt;object&gt;</span>,
  <span style="color:#008000;font-weight:bold">&#34;externalURL&#34;</span>: <span style="">&lt;string&gt;</span>,  <span style="">//</span> <span style="">指向AlertManager的反向链接</span>
  <span style="color:#008000;font-weight:bold">&#34;alerts&#34;</span>: [
    {
      <span style="color:#008000;font-weight:bold">&#34;status&#34;</span>: <span style="color:#ba2121">&#34;&lt;resolved|firing&gt;&#34;</span>,
      <span style="color:#008000;font-weight:bold">&#34;labels&#34;</span>: <span style="">&lt;object&gt;</span>,
      <span style="color:#008000;font-weight:bold">&#34;annotations&#34;</span>: <span style="">&lt;object&gt;</span>,
      <span style="color:#008000;font-weight:bold">&#34;startsAt&#34;</span>: <span style="color:#ba2121">&#34;&lt;rfc3339&gt;&#34;</span>,
      <span style="color:#008000;font-weight:bold">&#34;endsAt&#34;</span>: <span style="color:#ba2121">&#34;&lt;rfc3339&gt;&#34;</span>,
      <span style="color:#008000;font-weight:bold">&#34;generatorURL&#34;</span>: <span style="">&lt;string&gt;</span> <span style="">//</span> <span style="">标识导致警报的实体</span>
    },
    <span style="">...</span>
  ]
}
</code></pre></div><p>&lt;wechat_config&gt;</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#408080;font-style:italic"># 是否通知已解决的警报</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">[ send_resolved</span>:<span style="color:#bbb"> </span>&lt;boolean&gt; | default = false ]<span style="color:#bbb">
</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#408080;font-style:italic"># 与微信API通信时要使用的API密钥</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">[ api_secret</span>:<span style="color:#bbb"> </span>&lt;secret&gt; | default = global.wechat_api_secret ]<span style="color:#bbb">
</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#408080;font-style:italic"># 微信api网址</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">[ api_url</span>:<span style="color:#bbb"> </span>&lt;string&gt; | default = global.wechat_api_url ]<span style="color:#bbb">
</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#408080;font-style:italic"># 用于身份验证的公司ID</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">[ corp_id</span>:<span style="color:#bbb"> </span>&lt;string&gt; | default = global.wechat_api_corp_id ]<span style="color:#bbb">
</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#408080;font-style:italic"># 微信API定义的API请求数据</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">[ message</span>:<span style="color:#bbb"> </span>&lt;tmpl_string&gt; | default = &#39;{{ template &#34;wechat.default.message&#34; . }}&#39; ]<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">[ agent_id</span>:<span style="color:#bbb"> </span>&lt;string&gt; | default = &#39;{{ template &#34;wechat.default.agent_id&#34; . }}&#39; ]<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">[ to_user</span>:<span style="color:#bbb"> </span>&lt;string&gt; | default = &#39;{{ template &#34;wechat.default.to_user&#34; . }}&#39; ]<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">[ to_party</span>:<span style="color:#bbb"> </span>&lt;string&gt; | default = &#39;{{ template &#34;wechat.default.to_party&#34; . }}&#39; ]<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">[ to_tag</span>:<span style="color:#bbb"> </span>&lt;string&gt; | default = &#39;{{ template &#34;wechat.default.to_tag&#34; . }}&#39; ]<span style="color:#bbb">
</span></code></pre></div><h2 id="搭建alertmanager服务">搭建AlertManager服务</h2>
<p>部署AlertManager可以通过官网<a href="https://prometheus.io/download/">https://prometheus.io/download/</a>下载二进制文件.
这里演示docker部署AlertManager服务.其他方式请参考官网.</p>
<p>docker部署前,需要先完成配置文件的工作.</p>
<p>我在/home/along/下创建了一个配置文件 <code>touch alertmanager.yml</code>
之后编辑 <code>vi alertmanager.yml</code>,具体看上文的配置介绍.</p>
<p>启动容器:</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">docker run -d -p 9093:9093 --name alertmanagter
-v /home/along/alertmanager.yml:/etc/alertmanager/alertmanager.yml
quay.io/prometheus/alertmanager <span style="color:#ba2121">```</span>

如果加载模板的话需要挂在一下模板目录<span style="color:#666">(</span>模板在下面有介绍<span style="color:#666">)</span>:
<span style="color:#ba2121">```</span>bash
docker run -d -p 9093:9093 --name alert9093
-v /home/along/alertmanager/alertmanager.yml:/etc/alertmanager/alertmanager.yml
-v /home/along/alertmanager/template:/alertmanager/template
quay.io/prometheus/alertmanager<span style="color:#ba2121">```</span>

服务端口9093,挂在刚才设定的配置文件.

访问IP:9093 可以查看AlertManager的web界面<span style="color:#666">(</span>类似prometheus的web界面<span style="color:#666">)</span>.


<span style="color:#408080;font-style:italic">## 定义Prometheus警报规则并引入配置</span>

<span style="color:#408080;font-style:italic">### 配置警报规则文件</span>

警报规则文件顾名思义,你想监控的指标何时需要警报. 
例如设备温度超过多少要警告.
创建alert.yml,<span style="color:#ba2121">`</span>touch alert.yml<span style="color:#ba2121">`</span> 
<span style="color:#ba2121">```</span>yaml
groups:
- name: metricsUp                           <span style="color:#408080;font-style:italic"># 定义这组告警的组名</span>
rules:
  - alert: 监测对象挂了                       <span style="color:#408080;font-style:italic"># 警报名 可理解为警告的标题 </span>
    expr: up<span style="color:#666">{</span><span style="color:#19177c">instance</span><span style="color:#666">=</span><span style="color:#ba2121">&#34;192.168.23.11:9090&#34;</span><span style="color:#666">}</span> <span style="color:#666">==</span> <span style="color:#666">0</span>  <span style="color:#408080;font-style:italic"># 判断某值的规则</span>
    <span style="color:#008000;font-weight:bold">for</span>: 5m                                 <span style="color:#408080;font-style:italic"># 上面规则持续5分钟为0进行告警,5分钟内触发是pending状态</span>
    labels:                                 <span style="color:#408080;font-style:italic"># 定义警报标签</span>
      severity: waring                      <span style="color:#408080;font-style:italic"># 定义警报等级为 waring</span>
    annotations:                            <span style="color:#408080;font-style:italic"># 备注描述</span>
      summary: <span style="color:#ba2121">&#34;设备: {{ </span><span style="color:#19177c">$labels</span><span style="color:#ba2121">.instance }} 已断开5分钟&#34;</span>   <span style="color:#408080;font-style:italic"># 警告中呈现的具体信息可以写在这里</span>
</code></pre></div><h3 id="prometheus引入配置">Prometheus引入配置</h3>
<p>警报规则是Prometheus引入的文件.
Prometheus引入文件的方式:</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#008000;font-weight:bold">rule_files</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span>- <span style="color:#ba2121">&#34;/usr/local/prometheus/alert.yml&#34;</span><span style="color:#bbb"> </span><span style="color:#408080;font-style:italic"># 引入定义的警报规则</span><span style="color:#bbb">
</span></code></pre></div><h2 id="测试警报">测试警报</h2>
<p>我们上面配置好之后,需要各服务已经读取到相关配置文件了之后开始测试.
上面的规则是监测某个监控节点断开,手动断开一个节点.然后5分钟之后观察是否得到警报.</p>
<p>当由警报时收到的邮件为:</p>
<p><img src="https://s2.ax1x.com/2019/10/29/KRVQMT.png" alt=""></p>
<p>访问AlertManager页面也可以看到告警信息:</p>
<p><img src="https://s2.ax1x.com/2019/10/29/KRV1LF.png" alt=""></p>
<p>这里图例有些是演示用,与其他可能不存在关系.(不是同时截图的业务,图片仅供参考)</p>
<h3 id="静默操作演示">静默操作演示</h3>
<p>如果有些警报是我们调试的,例如我这里设置值偏低来演示ping值警报,如果我们测时候不想看到警报,可以通过静默来不让他总是发送警报.</p>
<p><img src="https://s2.ax1x.com/2019/10/29/KRVlsU.md.png" alt=""></p>
<p><img src="https://s2.ax1x.com/2019/10/29/KRV8Z4.md.png" alt=""></p>
<p>之后点击create 就可以创建此警报的静默操作.</p>
<p><strong>也可以通过正则,警报组名,实例等来静默各种警报.</strong></p>
<h2 id="定义通知模板">定义通知模板</h2>
<p>默认模板我们看到了,他是默认的一个告警模板,在我们测试时候可以使用,如果面向用户使用者似乎这个模板不太友好.
而且在面对多数据展示时,此模板也显得不是很清晰.</p>
<p>通过定义了模板,在触发不同警报可以通过AlertManager中,receivers选项来选择模板.</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#008000;font-weight:bold">templates</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span>- <span style="color:#ba2121">&#39;template/*.tmpl&#39;</span><span style="color:#bbb">           </span><span style="color:#408080;font-style:italic"># 定义模板中心</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">receivers</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span>- <span style="color:#008000;font-weight:bold">name</span>:<span style="color:#bbb"> </span><span style="color:#ba2121">&#39;email&#39;</span><span style="color:#bbb">               </span><span style="color:#408080;font-style:italic"># 警报</span><span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">email_configs</span>:<span style="color:#bbb">              </span><span style="color:#408080;font-style:italic"># 邮箱配置</span><span style="color:#bbb">
</span><span style="color:#bbb">    </span>- <span style="color:#008000;font-weight:bold">to</span>:<span style="color:#bbb"> </span><span style="color:#ba2121">&#39;******@163.com&#39;</span><span style="color:#bbb">      </span><span style="color:#408080;font-style:italic"># 接收警报的email配置</span><span style="color:#bbb">
</span><span style="color:#bbb">      </span><span style="color:#008000;font-weight:bold">html</span>:<span style="color:#bbb"> </span><span style="color:#ba2121">&#39;{{ template &#34;test.html&#34; . }}&#39;</span><span style="color:#bbb">      </span><span style="color:#408080;font-style:italic"># 设定邮箱的内容模板</span><span style="color:#bbb">
</span><span style="color:#bbb">      </span><span style="color:#008000;font-weight:bold">headers</span>:<span style="color:#bbb"> </span>{<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">Subject</span>:<span style="color:#bbb"> </span><span style="color:#ba2121">&#34;[WARN] 报警邮件&#34;</span>}<span style="color:#bbb">     </span><span style="color:#408080;font-style:italic"># 接收邮件的标题</span><span style="color:#bbb">
</span></code></pre></div><p>这段配置中,可以看到警报通过test.html作为模板的.他的位置在上面的定义中可以看到是 template/test.html (<strong>如果模板定制有错误,警报可能为空板,不能正常显示内容</strong>)
现在来配置这个test.html</p>
<p>在 /template/ 下创建 <code>touch test.html</code>
模板基于Go的模板系统,<a href="http://golang.org/pkg/text/template">详情点击这里</a>
如果不想深入连接可以结合默认模板模仿一下语法,<a href="https://github.com/prometheus/alertmanager/blob/master/template/default.tmpl">默认模板点击这里</a></p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-tmpl" data-lang="tmpl">{{ define &#34;email.demo.html&#34; }}
&lt;pre&gt;
&lt;table border=&#34;1&#34; cellspacing=&#34;0&#34;&gt;
    &lt;tr&gt;
        &lt;td&gt;报警名&lt;/td&gt;
        &lt;td&gt;设备&lt;/td&gt;
        &lt;td&gt;发现时间&lt;/td&gt;
        &lt;td&gt;详情&lt;/td&gt;
    &lt;/tr&gt;
    {{ range $i, <span style="color:#bc7a00">$</span>alert := .Alerts }}
    &lt;tr&gt;
        &lt;td&gt;{{ index <span style="color:#bc7a00">$</span>alert<span style="color:#666">.</span>Labels &#34;alertname&#34; }}&lt;/td&gt;
        &lt;td&gt;{{ <span style="color:#bc7a00">$</span>alert<span style="color:#666">.</span>Labels<span style="color:#666">.</span>instance }}&lt;/td&gt;
        &lt;td&gt;{{ <span style="color:#bc7a00">$</span>alert<span style="color:#666">.</span>StartsAt<span style="color:#666">.</span>Format &#34;2006-01-02 15:04:05&#34; }}&lt;/td&gt;
        &lt;td&gt;{{ <span style="color:#bc7a00">$</span>alert<span style="color:#666">.</span>Annotations<span style="color:#666">.</span>summary }}&lt;/td&gt;
    &lt;/tr&gt;
    {{ end }}
&lt;/table&gt;
&lt;/pre&gt;
{{ end }}
</code></pre></div><p>模板保存后,测试邮件接收情况:
<img src="https://s2.ax1x.com/2019/10/29/KR89WF.png" alt=""></p>
<h4 id="模板时区问题">模板时区问题</h4>
<p>Prometheus中所有时间都是UTC时间,为了便于我们展示友好时间(东八区),我们需要计算一下时间.
修改模板时间:</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">&lt;td&gt;{{ ($alert.StartsAt.Add 28800e9).Format &#34;2006-01-02 15:04:05&#34; }}&lt;/td&gt;<span style="color:#bbb">
</span></code></pre></div><p><em>参考</em>
<a href="http://www.ishenping.com/ArtInfo/1265281.html#Comment">ishenping</a>
<a href="https://songjiayang.gitbooks.io/prometheus/content/alertmanager/email.html">songjiayang</a>
<a href="https://prometheus.io/docs/alerting/alertmanager/">prometheus.io</a></p>


    <footer class="site-footer">
  <span class="site-footer-credits">
    Made with <a href="https://gohugo.io/">Hugo</a>. Themed by <a href="https://github.com/zwbetz-gh/cayman-hugo-theme">Cayman</a>. Deployed to <a href="https://www.netlify.com/">Netlify</a>.
  </span>
</footer>

  </section>
  
  

</body>
</html>
