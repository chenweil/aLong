<!doctype html><html lang=en><head><script src="/aLong/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=aLong/livereload" data-no-instant defer></script><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><style>:root{--accent-color:#FF4D4D}</style><title>M3DB笔记</title>
<meta name=description content="M3DB笔记 前阵子研究prometheus,初期没有考虑存储问题.本地默认存储30天数据.
监控已经折腾完毕,现在需要来处理存储的方案.
通过互联网的科普,发现目前有两个方案可以解决这个问题.
thanos
M3DB
thanos是需要存储云端数据(本地存储官方不推荐).不符合我们的考虑范围内.那就来学习M3DB了. …"><meta name=keywords content='blog,aLong,blog.51ai.vip,M3DB'><meta property="og:url" content="http://localhost:1313/aLong/posts/m3db%E7%AC%94%E8%AE%B0/"><meta property="og:type" content="website"><meta property="og:title" content="M3DB笔记"><meta property="og:description" content="M3DB笔记 前阵子研究prometheus,初期没有考虑存储问题.本地默认存储30天数据.
监控已经折腾完毕,现在需要来处理存储的方案.
通过互联网的科普,发现目前有两个方案可以解决这个问题.
thanos
M3DB
thanos是需要存储云端数据(本地存储官方不推荐).不符合我们的考虑范围内.那就来学习M3DB了. …"><meta property="og:image" content="http://localhost:1313/aLong/"><meta property="og:image:secure_url" content="http://localhost:1313/aLong/"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="M3DB笔记"><meta name=twitter:description content="M3DB笔记 前阵子研究prometheus,初期没有考虑存储问题.本地默认存储30天数据.
监控已经折腾完毕,现在需要来处理存储的方案.
通过互联网的科普,发现目前有两个方案可以解决这个问题.
thanos
M3DB
thanos是需要存储云端数据(本地存储官方不推荐).不符合我们的考虑范围内.那就来学习M3DB了. …"><meta property="twitter:domain" content="http://localhost:1313/aLong/posts/m3db%E7%AC%94%E8%AE%B0/"><meta property="twitter:url" content="http://localhost:1313/aLong/posts/m3db%E7%AC%94%E8%AE%B0/"><meta name=twitter:image content="http://localhost:1313/aLong/"><link rel=canonical href=http://localhost:1313/aLong/posts/m3db%E7%AC%94%E8%AE%B0/><link rel=stylesheet type=text/css href=/aLong/css/normalize.min.css media=print><link rel=stylesheet type=text/css href=/aLong/css/main.min.css><link id=dark-theme rel=stylesheet href=/aLong/css/dark.min.css><script src=/aLong/js/bundle.min.9a920d7dabdbad8363b6a0a94e29a9dfebdb7ee64cfcb193a0145e512ef2bdab.js integrity="sha256-mpINfavbrYNjtqCpTimp3+vbfuZM/LGToBReUS7yvas="></script></head><body><script>setThemeByUserPref()</script><header class=header><nav class=header-nav><div class=nav-title><a class=nav-brand href=http://localhost:1313/aLong/>aLong Blog</a></div><div class=nav-links><div class=nav-link><a href=http://localhost:1313/aLong/><span data-feather=home></span> Home</a></div><div class=nav-link><a href=http://localhost:1313/aLong/posts/>Posts</a></div><div class=nav-link><a href=http://localhost:1313/aLong/tags/>Tags</a></div><div class=nav-link><a href=http://localhost:1313/aLong/index.xml><span data-feather=rss></span></a></div><span class=nav-icons-divider></span><div class="nav-link dark-theme-toggle"><span class="sr-only dark-theme-toggle-screen-reader-target"></span>
<a><span class=theme-toggle-icon data-feather=moon></span></a></div><div class=nav-link id=hamburger-menu-toggle><span class="sr-only hamburger-menu-toggle-screen-reader-target">menu</span>
<a><span data-feather=menu></span></a></div><ul class="nav-hamburger-list visibility-hidden"><li class=nav-item><a href=http://localhost:1313/aLong/><span data-feather=home></span> Home</a></li><li class=nav-item><a href=http://localhost:1313/aLong/posts/>Posts</a></li><li class=nav-item><a href=http://localhost:1313/aLong/tags/>Tags</a></li><li class=nav-item><a href=http://localhost:1313/aLong/index.xml><span data-feather=rss></span></a></li><li class="nav-item dark-theme-toggle"><span class="sr-only dark-theme-toggle-screen-reader-target">theme</span>
<a><span class=theme-toggle-icon data-feather=moon></span></a></li></ul></div></nav></header><main id=content><div class="post container"><div class=post-header-section><h1>M3DB笔记</h1><small role=doc-subtitle></small><p class=post-date>2019/11/29</p><ul class=post-tags><li class=post-tag><a href=http://localhost:1313/aLong/tags/m3db>M3DB</a></li></ul></div><div class=post-content><h2 id=m3db笔记>M3DB笔记</h2><p>前阵子研究prometheus,初期没有考虑存储问题.本地默认存储30天数据.</p><p>监控已经折腾完毕,现在需要来处理存储的方案.</p><p>通过互联网的科普,发现目前有两个方案可以解决这个问题.</p><ol><li><p>thanos</p></li><li><p>M3DB</p><p>thanos是需要存储云端数据(本地存储官方不推荐).不符合我们的考虑范围内.那就来学习M3DB了.</p></li></ol><h3 id=简介>简介</h3><blockquote><p>M3可以在较长的保留时间内可靠地存储大规模指标。为了向更广泛的社区中的其他人提供这些好处，我们决定开放M3平台作为Prometheus的远程存储后端，Prometheus是一种流行的监控和警报解决方案。正如其文档所述，Prometheus的可扩展性和耐用性受到单个节点的限制。 M3平台旨在为Prometheus指标提供安全，可扩展且可配置的多租户的存储。</p><p>M3于2015年发布，目前拥有超过66亿个时间序列。 M3每秒聚合5亿个指标，并在全球范围内（使用M3DB）每秒持续存储2000万个度量指标，批量写入将每个指标持久保存到区域中的三个副本。它还允许工程师编写度量策略，告诉M3以更短或更长的保留时间（两天，一个月，六个月，一年，三年，五年等）以特定的粒度（一秒，十秒，一分钟，十分钟等）。这允许工程师和数据科学家使用与定义的存储策略匹配的度量标签（标签），在精细和粗粒度范围内智能地存储不同保留的时间序列。例如，工程师可以选择存储“应用程序”标记为“mobile_api”且“端点”标记为“注册”的所有度量标准，这些标记在10秒粒度下为30天，在一小时粒度下为5年。</p></blockquote><h3 id=相关组件>相关组件</h3><blockquote><h4 id=m3-coordinator>M3 Coordinator</h4><p>M3 Coordinator是一种服务，用于协调上游系统（如Prometheus和M3DB）之间的读写操作。它还提供了管理API，用于设置和配置M3的不同部分。它是用户可以部署以访问M3DB的优势的桥梁，例如长期存储和与其他监控系统（如Prometheus）的多DC设置。</p><h4 id=m3db>M3DB</h4><p>M3DB是一个分布式时间序列数据库，提供可扩展存储和时间序列的反向索引。它经过优化，具有成本效益和可靠的实时和长期保留指标存储和索引</p><h4 id=m3-query>M3 Query</h4><p>M3 Query是一种服务，它包含一个分布式查询引擎，用于查询实时和历史指标，支持多种不同的查询语言。它旨在支持低延迟实时查询和可能需要更长时间执行的查询，聚合更大的数据集，用于分析用例</p><h4 id=m3-aggregator>M3 Aggregator</h4><p>M3 Aggregator是一种作为专用度量聚合器运行的服务，它基于存储在etcd中的动态规则提供基于流的下采样。它使用领导者选举和聚合窗口跟踪，利用etcd来管理此状态，从而可靠地为低采样度量标准发送至少一次聚合到长期存储。这提供了成本有效且可靠的下采样和汇总指标。这些功能也存在于M3协调器中，但专用聚合器是分片和复制的，而M3协调器则不需要并且需要谨慎部署和以高可用性方式运行。还有一些工作要使用户更容易访问聚合器，而无需他们编写自己的兼容生产者和消费者。</p></blockquote><h3 id=入门>入门</h3><p><img src=https://t1.picb.cc/uploads/2019/11/29/kIj7yu.png alt></p><p>上面的组件通俗讲:</p><p><em>prometheus</em> 需要通过<em>M3 Coordinator</em>来协调存储与查询到M3DB,<em>prometheus</em>本地存储数据时间与这个没关系.</p><p>上面没有提到一个名字etcd服务.此服务推断拓扑\配置功能. 如果db嵌入此服务就称为种子节点SeedNode.</p><hr><p>官方提供了一个镜象,里面包含 M3 Coordinator + SeedNode.</p><p>拉取镜象:<code>docker pull quay.io/m3db/m3dbnode:latest</code></p><p>启动名为m3db容器:<code>docker run -d -p 7201:7201 -p 7203:7203 -p 9003:9003 --name m3db -v $(pwd)/m3db_data:/var/lib/m3db quay.io/m3db/m3dbnode:latest</code></p><p>该容器的端口为7201（用于管理集群拓扑），端口为7203，Prometheus用来刮除M3DB和M3Coordinator生成的度量，端口9003（用于读取和写入度量）已公开。</p><p>这时候m3db已经启动,需要创建一个初始命名空间.官方镜象默认是type:local,namespace:default. 这个可以进入容器查看到配置位置<code>/etc/d3dbnode/m3dbnode.yml</code>.如果我们创建其他命名空间需要在m3coordinator中配置好.</p><p><code>curl -X POST http://localhost:7201/api/v1/database/create -d '{ "type": "local", "namespaceName": "default", "retentionTime": "24h" }'</code></p><p>这里配置的参数除了type与namespaceName,还有一个保留时间.超过时间就被清除了.我们测试设置24小时可以了,如果我是监测自己的设备,不是生产的情况其实偷懒可以用这个单机存储设置一个较长时间.例如:1y(看你了兄嘚).</p><p>设置完稍等几分钟就可以使用了.</p><p>通过接口可以查看: <code>curl http://localhost:7201/api/v1/placement</code></p><p>看到很多<code>AVAILABLE</code> 就是ok了.</p><p>访问<code>localhost:7201/api/v1/openapi</code> 可以看到官方提供的接口文档.</p><h3 id=配置远程读写>配置远程读写</h3><p>上面的库已经ok了,现在配置一下Prometheus.配置很简单只有两条.一条写,一条读.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>remote_read</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>url</span>: <span style=color:#e6db74>&#34;http://localhost:7201/api/v1/prom/remote/read&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>read_recent</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>remote_write</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>url</span>: <span style=color:#e6db74>&#34;http://localhost:7201/api/v1/prom/remote/write&#34;</span>
</span></span></code></pre></div><h3 id=监控指标>监控指标</h3><p>我们这个用的是官方提供的镜象,嵌入式M3Coordinator的M3DB.所以按照下面这种方式配置.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>job_name</span>: <span style=color:#e6db74>&#39;m3&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>static_configs</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>targets</span>: [<span style=color:#e6db74>&#39;&lt;HOST_NAME&gt;:7203&#39;</span>]
</span></span></code></pre></div></div><div class=prev-next></div><svg id="btt-button" class="arrow-logo" height="1em" viewBox="0 0 384 512" onclick="scrollToTop()" title="Go to top"><path d="M177 159.7l136 136c9.4 9.4 9.4 24.6.0 33.9l-22.6 22.6c-9.4 9.4-24.6 9.4-33.9.0L160 255.9l-96.4 96.4c-9.4 9.4-24.6 9.4-33.9.0L7 329.7c-9.4-9.4-9.4-24.6.0-33.9l136-136c9.4-9.5 24.6-9.5 34-.1z"/></svg>
<script>let backToTopButton=document.getElementById("btt-button");window.onscroll=function(){scrollFunction()};function scrollFunction(){document.body.scrollTop>20||document.documentElement.scrollTop>20?backToTopButton.style.display="block":backToTopButton.style.display="none"}function scrollToTop(){window.scrollTo(0,0)}</script></div></main><footer class=footer><span>&copy; 2019 aLong</span>
<span>Made with &#10084;&#65039; using <a target=_blank href=https://github.com/526avijitgupta/gokarna>Gokarna</a></span></footer></body></html>