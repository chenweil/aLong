<!doctype html><html lang=en><head><script src="/aLong/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=aLong/livereload" data-no-instant defer></script><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><style>:root{--accent-color:#FF4D4D}</style><title>Prometheus-snmp_export部署</title>
<meta name=description content="SNMP SNMP(simple network management protocol)是因特网架构委员会IAB定义的一个应用层协议。SNMP广泛用于管理和监控网络设备，大多数专业的网络设备都有SNMP agent代理，这些代理被激活和配置后用于和SNMP管理 NMS(network management …"><meta name=keywords content='blog,aLong,blog.51ai.vip,SNMP,Promethues'><meta property="og:url" content="http://localhost:1313/aLong/prometheus-snmp-export%E9%83%A8%E7%BD%B2/"><meta property="og:type" content="website"><meta property="og:title" content="Prometheus-snmp_export部署"><meta property="og:description" content="SNMP SNMP(simple network management protocol)是因特网架构委员会IAB定义的一个应用层协议。SNMP广泛用于管理和监控网络设备，大多数专业的网络设备都有SNMP agent代理，这些代理被激活和配置后用于和SNMP管理 NMS(network management …"><meta property="og:image" content="http://localhost:1313/aLong/"><meta property="og:image:secure_url" content="http://localhost:1313/aLong/"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="Prometheus-snmp_export部署"><meta name=twitter:description content="SNMP SNMP(simple network management protocol)是因特网架构委员会IAB定义的一个应用层协议。SNMP广泛用于管理和监控网络设备，大多数专业的网络设备都有SNMP agent代理，这些代理被激活和配置后用于和SNMP管理 NMS(network management …"><meta property="twitter:domain" content="http://localhost:1313/aLong/prometheus-snmp-export%E9%83%A8%E7%BD%B2/"><meta property="twitter:url" content="http://localhost:1313/aLong/prometheus-snmp-export%E9%83%A8%E7%BD%B2/"><meta name=twitter:image content="http://localhost:1313/aLong/"><link rel=canonical href=http://localhost:1313/aLong/prometheus-snmp-export%E9%83%A8%E7%BD%B2/><link rel=stylesheet type=text/css href=/aLong/css/normalize.min.css media=print><link rel=stylesheet type=text/css href=/aLong/css/main.min.css><link id=dark-theme rel=stylesheet href=/aLong/css/dark.min.css><script src=/aLong/js/bundle.min.9a920d7dabdbad8363b6a0a94e29a9dfebdb7ee64cfcb193a0145e512ef2bdab.js integrity="sha256-mpINfavbrYNjtqCpTimp3+vbfuZM/LGToBReUS7yvas="></script></head><body><script>setThemeByUserPref()</script><header class=header><nav class=header-nav><div class=nav-title><a class=nav-brand href=http://localhost:1313/aLong/>aLong Blog</a></div><div class=nav-links><div class=nav-link><a href=http://localhost:1313/aLong/><span data-feather=home></span> Home</a></div><div class=nav-link><a href=http://localhost:1313/aLong/posts/>Posts</a></div><div class=nav-link><a href=http://localhost:1313/aLong/tags/>Tags</a></div><div class=nav-link><a href=http://localhost:1313/aLong/index.xml><span data-feather=rss></span></a></div><span class=nav-icons-divider></span><div class="nav-link dark-theme-toggle"><span class="sr-only dark-theme-toggle-screen-reader-target"></span>
<a><span class=theme-toggle-icon data-feather=moon></span></a></div><div class=nav-link id=hamburger-menu-toggle><span class="sr-only hamburger-menu-toggle-screen-reader-target">menu</span>
<a><span data-feather=menu></span></a></div><ul class="nav-hamburger-list visibility-hidden"><li class=nav-item><a href=http://localhost:1313/aLong/><span data-feather=home></span> Home</a></li><li class=nav-item><a href=http://localhost:1313/aLong/posts/>Posts</a></li><li class=nav-item><a href=http://localhost:1313/aLong/tags/>Tags</a></li><li class=nav-item><a href=http://localhost:1313/aLong/index.xml><span data-feather=rss></span></a></li><li class="nav-item dark-theme-toggle"><span class="sr-only dark-theme-toggle-screen-reader-target">theme</span>
<a><span class=theme-toggle-icon data-feather=moon></span></a></li></ul></div></nav></header><main id=content><div class="post container"><div class=post-header-section><h1>Prometheus-snmp_export部署</h1><small role=doc-subtitle></small><p class=post-date>2019/08/29</p><ul class=post-tags><li class=post-tag><a href=http://localhost:1313/aLong/tags/snmp>SNMP</a></li><li class=post-tag><a href=http://localhost:1313/aLong/tags/promethues>Promethues</a></li></ul></div><div class=post-content><h2 id=snmp>SNMP</h2><p>SNMP(simple network management protocol)是因特网架构委员会IAB定义的一个应用层协议。SNMP广泛用于管理和监控网络设备，大多数专业的网络设备都有SNMP agent代理，这些代理被激活和配置后用于和SNMP管理 NMS(network management system)网络管理系统通信。</p><h2 id=目的>目的</h2><p>通过snmp_export,获取设备信息.</p><h2 id=准备>准备</h2><p>系统: centos7,docker19.
之前已经安装好 Prometheus</p><p>此处目标设备是华为交换机 s2700</p><h2 id=部署snmp_expoer>部署snmp_expoer</h2><p>snmp.yml 配置文件不是自己定义的,是通过注册生成或下载的.这里我通过github下载配置文件.</p><p><a href=https://github.com/prometheus/snmp_exporter/blob/master/snmp.yml>snmp.yml</a></p><ul><li>配置snmp_export 配置文件 snmp.yml</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span><span style=color:#f92672>version</span>: <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span><span style=color:#f92672>auth</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>community</span>: <span style=color:#75715e>**交换机设置的团体名**</span>
</span></span></code></pre></div><p>查找到if_mib 再此段结尾中加入 上面的配置(大概行数6199).</p><p><img src=https://t1.picb.cc/uploads/2019/08/29/gjuSAc.png alt=demo></p><h3 id=部署snmp_expor>部署snmp_expor</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker run -d --restart always <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>-v /home/along/snmp.yml:/etc/snmp_exporter/snmp.yml <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>-p 9116:9116 --name snmp-exporter prom/snmp-exporter <span style=color:#ae81ff>\ </span>--config.file<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/etc/snmp_exporter/snmp.yml&#34;</span>
</span></span></code></pre></div><h3 id=配置华为s2700交换机>配置华为s2700交换机</h3><p>自行查阅文档.懒得写了.</p><h3 id=验证服务>验证服务</h3><p>访问 http://IP:9116/metrics 能返回数据,snmp_export服务正常.</p><p>测试是否能获取到目标设备的数据:
访问 http://IP:9116/snmp?target=DEVIP
能获取到数据,配置成功.</p><p><strong>注意防火墙 把需要的端口加入规则中,不然访问不到排查绕弯路</strong></p><h3 id=配置promthues>配置promthues</h3><p>修改 promthues.yml文件. 添加一个新的job.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span>- <span style=color:#f92672>job_name</span>: <span style=color:#ae81ff>snmp</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>honor_timestamps</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>params</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>module</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>if_mib</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>scrape_interval</span>: <span style=color:#ae81ff>15s</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>scrape_timeout</span>: <span style=color:#ae81ff>10s</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>metrics_path</span>: <span style=color:#ae81ff>/snmp</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>scheme</span>: <span style=color:#ae81ff>http</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>static_configs</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>targets</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>172.16.23.253</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>tag</span>: <span style=color:#ae81ff>huawei-switch-s2700</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>relabel_configs</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>source_labels</span>: [<span style=color:#ae81ff>__address__]</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>separator</span>: <span style=color:#ae81ff>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>regex</span>: <span style=color:#ae81ff>(.*)</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>target_label</span>: <span style=color:#ae81ff>__param_target</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>replacement</span>: <span style=color:#ae81ff>$1</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>action</span>: <span style=color:#ae81ff>replace</span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>source_labels</span>: [<span style=color:#ae81ff>__param_target]</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>separator</span>: <span style=color:#ae81ff>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>regex</span>: <span style=color:#ae81ff>(.*)</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>target_label</span>: <span style=color:#ae81ff>instance</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>replacement</span>: <span style=color:#ae81ff>$1</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>action</span>: <span style=color:#ae81ff>replace</span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>separator</span>: <span style=color:#ae81ff>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>regex</span>: <span style=color:#ae81ff>(.*)</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>target_label</span>: <span style=color:#ae81ff>__address__</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>replacement</span>: <span style=color:#ae81ff>172.16.23.12</span>:<span style=color:#ae81ff>9116</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>action</span>: <span style=color:#ae81ff>replace</span>
</span></span></code></pre></div><p>之前部署prometheus 有一个参数是为了热加载配置的.
这里需要reload一下配置,<code>curl -X POST http://IP:9090/-/reload</code>,如果你没有就重启服务吧.</p><h3 id=验证-prometheus配置>验证 Prometheus配置</h3><p>访问 http://IP:9090/
点击 Status->Target 可以看到监控的节点,之前我们是有一个,现在是两个节点了.</p><p><img src=https://t1.picb.cc/uploads/2019/08/29/gjCvPF.png alt></p><p>有数据之后,就可以在grafana中展示设备的数据了.</p><h2 id=参考>参考</h2><p><a href=https://github.com/prometheus/snmp_exporter>https://github.com/prometheus/snmp_exporter</a></p><p><a href=https://prometheus.io/docs/instrumenting/exporters/>https://prometheus.io/docs/instrumenting/exporters/</a></p><p><a href=http://owelinux.github.io/owelinux.github.io/2018/07/25/article8-linux-prometheus/>http://owelinux.github.io/owelinux.github.io/2018/07/25/article8-linux-prometheus/</a></p></div><div class=prev-next></div><svg id="btt-button" class="arrow-logo" height="1em" viewBox="0 0 384 512" onclick="scrollToTop()" title="Go to top"><path d="M177 159.7l136 136c9.4 9.4 9.4 24.6.0 33.9l-22.6 22.6c-9.4 9.4-24.6 9.4-33.9.0L160 255.9l-96.4 96.4c-9.4 9.4-24.6 9.4-33.9.0L7 329.7c-9.4-9.4-9.4-24.6.0-33.9l136-136c9.4-9.5 24.6-9.5 34-.1z"/></svg>
<script>let backToTopButton=document.getElementById("btt-button");window.onscroll=function(){scrollFunction()};function scrollFunction(){document.body.scrollTop>20||document.documentElement.scrollTop>20?backToTopButton.style.display="block":backToTopButton.style.display="none"}function scrollToTop(){window.scrollTo(0,0)}</script></div></main><footer class=footer><span>&copy; 2019 aLong</span>
<span>Made with &#10084;&#65039; using <a target=_blank href=https://github.com/526avijitgupta/gokarna>Gokarna</a></span></footer></body></html>